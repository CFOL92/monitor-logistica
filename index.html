<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Log√≠stica GPS Pro - RealTime</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Scripts de Firebase para base de datos en tiempo real -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Configuraci√≥n proporcionada por el entorno
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'logistica-gps';

        window.db = db;
        window.appId = appId;

        // Autenticaci√≥n obligatoria
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth().then(() => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    startRealtimeSync();
                }
            });
        });

        // Escuchar cambios en la base de datos de forma global
        function startRealtimeSync() {
            const visitasRef = collection(db, 'artifacts', appId, 'public', 'data', 'visitas');
            onSnapshot(visitasRef, (snapshot) => {
                window.visitasMemoria = {};
                snapshot.forEach((doc) => {
                    window.visitasMemoria[doc.id] = doc.data().visitado;
                });
                if (window.actualizarMapa) window.actualizarMapa();
            }, (error) => console.error("Error en tiempo real:", error));
        }

        // Funci√≥n para guardar en la nube
        window.saveVisitToCloud = async (codBoca, status) => {
            const visitDoc = doc(db, 'artifacts', appId, 'public', 'data', 'visitas', codBoca);
            await setDoc(visitDoc, { visitado: status, timestamp: new Date() });
        };

        // FUNCI√ìN DE RESETEO PROTEGIDA (SOLO ADMIN)
        window.borrarVisitas = async () => {
            const ADMIN_PIN = "1234"; // CAMBIA TU PIN AQU√ç
            const input = prompt("Ingrese el PIN de administrador para resetear el mapa:");
            
            if (input === ADMIN_PIN) {
                if (confirm("¬øEst√°s seguro de que quieres borrar TODAS las visitas? Esto afectar√° a todos los usuarios y al Excel.")) {
                    document.getElementById("contador").innerText = "Reseteando datos...";
                    try {
                        const visitasRef = collection(db, 'artifacts', appId, 'public', 'data', 'visitas');
                        const querySnapshot = await getDocs(visitasRef);
                        
                        const promesas = [];
                        querySnapshot.forEach((doc) => {
                            promesas.push(deleteDoc(doc.ref));
                        });
                        
                        await Promise.all(promesas);
                        alert("Mapa reseteado con √©xito. Nota: Los estados en el Excel se actualizar√°n la pr√≥xima vez que los choferes interact√∫en.");
                    } catch (e) {
                        alert("Error al borrar: " + e.message);
                    }
                }
            } else if (input !== null) {
                alert("PIN incorrecto. Funci√≥n bloqueada.");
            }
        };
    </script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f4f4f4; }
        #map { height: 100vh; width: 100%; }

        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.98); padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); width: 200px; 
            display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .label-filter { font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; 
            width: 100%; font-size: 12px; background-color: #fff; color: #1e293b;
            cursor: pointer; transition: border-color 0.2s;
        }

        .btn-config { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .btn-gps { background: #25D366; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #contador { font-size: 10px; text-align: center; color: #64748b; margin-top: 4px; font-weight: 500; }

        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-size: 10px; font-weight: 600 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.3s ease; pointer-events: none;
        }

        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        .leaflet-popup-content-wrapper { border-radius: 4px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        
        .popup-header { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .popup-header h3 { margin: 0; color: #333; font-size: 14px; font-weight: 800; text-transform: uppercase; }
        .popup-header .subtitle { color: #888; font-size: 10px; font-weight: 500; display: block; }

        .popup-badges { padding: 8px 15px; display: flex; flex-direction: column; gap: 4px; }
        .badge-driver { background: #00f2a1; color: #fff; padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: 800; text-transform: uppercase; width: fit-content; }
        .badge-channel { background: #4b5563; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 700; text-transform: uppercase; width: fit-content; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .popup-table tr td { padding: 7px 15px; border-bottom: 1px solid #f9fafb; }
        .popup-table tr td:first-child { background: #fcfcfc; color: #6b7280; font-weight: 500; width: 35%; }
        .popup-table tr td:last-child { text-align: right; color: #111827; font-weight: 600; }
        .popup-table .val-total { color: #0284c7 !important; font-weight: 800 !important; font-size: 12px; }

        .btn-visit-action { 
            width: 100%; border: none; padding: 12px; font-size: 10px; font-weight: 700; 
            text-transform: uppercase; cursor: pointer; background: #f3f4f6; color: #4b5563;
        }
        .btn-visit-action.active { background: #e5e7eb; color: #111827; text-decoration: line-through; }

        .nav-btn-footer { display: flex; align-items: center; justify-content: center; gap: 8px; background: #22c55e; color: white; text-align: center; padding: 14px; text-decoration: none; font-weight: 700; font-size: 13px; }

        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
        
        #panel-config { 
            display: none; position: absolute; top: 10px; left: 10px; z-index: 1001; 
            background: white; width: 280px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); flex-direction: column; 
        }
        .panel-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #0078d4; color: white; border-radius: 12px 12px 0 0; }
        .panel-body { padding: 15px; max-height: 70vh; overflow-y: auto; }
        .chofer-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">Transportadora</span>
            <select id="filtroTransp" onchange="cambioTransportadora()">
                <option value="todos">Cargando...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">Chofer</span>
            <select id="filtroChofer" onchange="actualizarMapa()">
                <option value="todos">...</option>
            </select>
        </div>
        <button class="btn-config" onclick="togglePanel()">‚öôÔ∏è CONFIGURACI√ìN</button>
        <div id="contador">Conectando...</div>
    </div>

    <div id="panel-config">
        <div class="panel-header">
            <strong>AJUSTES</strong> 
            <button onclick="togglePanel()" style="border:none;background:none;cursor:pointer;color:white;font-size:20px;">√ó</button>
        </div>
        <div class="panel-body">
            <span class="label-filter">Dise√±o de Icono</span>
            <select id="selectIcono" onchange="cambiarTipoIcono(this.value)" style="margin-bottom:15px">
                <option value="pin">Pin Profesional</option>
                <option value="circle">Punto Circular</option>
            </select>
            <div id="lista-colores">
                <span class="label-filter">Colores Chofer</span>
            </div>
            <button onclick="borrarVisitas()" style="width:100%; margin-top:20px; padding:12px; font-size:10px; background:#fef2f2; color:#b91c1c; border:1px solid #fee2e2; border-radius:6px; cursor:pointer; font-weight:800;">RESETEAR VISITAS (ADMIN)</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const COLOR_PREDETERMINADO = "#0ea5e9"; 
        const COLOR_VISITADO = "#64748b"; 

        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);

        var datosGlobales = [];
        var coloresMemoria = {};
        window.visitasMemoria = {}; 
        var tipoIconoGlobal = "pin"; 
        var userMarker = null; 
        var userCircle = null;

        try {
            coloresMemoria = JSON.parse(localStorage.getItem('coloresLogisticaV10') || '{}');
            tipoIconoGlobal = localStorage.getItem('tipoIconoV10') || 'pin';
            document.getElementById('selectIcono').value = tipoIconoGlobal;
        } catch (e) {}

        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', function() {
            var z = map.getZoom();
            if (z >= 14) { 
                document.body.classList.replace('zoom-low', 'zoom-high'); 
            } else { 
                document.body.classList.replace('zoom-high', 'zoom-low'); 
            }
        });

        function activarGPS() {
            document.getElementById("contador").innerText = "Ubicando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        }

        map.on('locationfound', function(e) {
            if (userMarker) { map.removeLayer(userMarker); map.removeLayer(userCircle); }
            userMarker = L.marker(e.latlng).addTo(map).bindPopup("Ubicaci√≥n actual").openPopup();
            userCircle = L.circle(e.latlng, e.accuracy/2, {color: '#22c55e', weight:1, fillOpacity: 0.1}).addTo(map);
            document.getElementById("contador").innerText = "GPS Conectado";
        });

        fetch(SHEET_API).then(r => r.json()).then(data => {
            datosGlobales = data;
            inicializarFiltros(data);
            actualizarMapa();
        });

        function inicializarFiltros(data) {
            var transportistas = [...new Set(data.map(d => d.Transp))].filter(Boolean).sort();
            llenarSelect("filtroTransp", transportistas, "TODAS LAS TRANSPORTADORAS");
            var choferes = [...new Set(data.map(d => d.Chofer))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS LOS CHOFERES");
            generarPanelColores(choferes);
        }

        function llenarSelect(id, lista, titulo) {
            var s = document.getElementById(id);
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => {
                var op = document.createElement("option"); op.value = i; op.innerText = i; s.appendChild(op);
            });
        }

        function cambioTransportadora() {
            var t = document.getElementById("filtroTransp").value;
            var fil = (t === "todos") ? datosGlobales : datosGlobales.filter(d => d.Transp === t);
            var choferes = [...new Set(fil.map(d => d.Chofer))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS LOS CHOFERES");
            actualizarMapa();
        }

        // --- FUNCI√ìN MEJORADA: ACTUALIZA NUBE Y EXCEL ---
        window.toggleVisitado = async (codBoca) => {
            const currentStatus = !!window.visitasMemoria[codBoca];
            const newStatus = !currentStatus;
            const labelStatus = newStatus ? 'Visitado' : 'Pendiente';

            // 1. Actualizar Nube (Firestore) para Sincronizaci√≥n en Vivo
            await window.saveVisitToCloud(codBoca, newStatus);
            
            // 2. Actualizar Google Sheets de forma as√≠ncrona (Segundo plano)
            const updateUrl = `${SHEET_API}?mode=update&codBoca=${codBoca}&status=${labelStatus}`;
            fetch(updateUrl, { mode: 'no-cors' }).catch(err => console.error("Error Excel:", err));

            map.closePopup();
        };

        function cambiarTipoIcono(val) {
            tipoIconoGlobal = val;
            localStorage.setItem('tipoIconoV10', val);
            actualizarMapa();
        }

        function darkenColor(hex, percent) {
            var num = parseInt(hex.replace("#",""),16),
            amt = Math.round(2.55 * percent),
            R = (num >> 16) - amt, G = (num >> 8 & 0x00FF) - amt, B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R<255?R<0?0:R:255)*0x10000 + (G<255?G<0?0:G:255)*0x100 + (B<255?B<0?0:B:255)).toString(16).slice(1);
        }

        function getPinSvg(color) {
            const darkCenter = darkenColor(color, 40); 
            return `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3))">
                <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${color}"/>
                <circle cx="12" cy="9" r="3.2" fill="${darkCenter}"/>
            </svg>`;
        }

        window.actualizarMapa = function() {
            if (!layerGroup) return;
            layerGroup.clearLayers();
            var t = document.getElementById("filtroTransp").value;
            var c = document.getElementById("filtroChofer").value;

            var fil = datosGlobales.filter(i => {
                if (t !== "todos" && i.Transp !== t) return false;
                if (c !== "todos" && i.Chofer !== c) return false;
                return true;
            });

            const grupos = {};
            fil.forEach(i => {
                const k = i.Chofer + "_" + (i.CodBoca || (i.Latitud + "" + i.Longitud));
                if (!grupos[k]) grupos[k] = { ...i, _f: [], _peso: 0, _imp: 0, _c: 0 };
                grupos[k]._f.push(i.NumFactura);
                grupos[k]._peso += parseFloat(String(i.Peso).replace(',','.')) || 0;
                grupos[k]._imp += parseFloat(String(i.Importe).replace(/,/g,'')) || 0;
                grupos[k]._c++;
            });

            Object.values(grupos).forEach(i => {
                var lat = parseFloat(String(i.Latitud).replace(',', '.'));
                var lon = parseFloat(String(i.Longitud).replace(',', '.'));
                if (isNaN(lat) || isNaN(lon)) return;

                const esVisitado = !!window.visitasMemoria[i.CodBoca];
                var colorBase = (t !== "todos" || c !== "todos") ? (coloresMemoria[i.Chofer] || COLOR_PREDETERMINADO) : COLOR_PREDETERMINADO;
                var colorActual = esVisitado ? COLOR_VISITADO : colorBase;
                
                var marker;
                if (tipoIconoGlobal === "circle") {
                    marker = L.circleMarker([lat, lon], { radius: 8, fillColor: colorActual, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 });
                } else {
                    marker = L.marker([lat, lon], {
                        icon: L.divIcon({ className: 'custom-div-icon', html: getPinSvg(colorActual), iconSize: [34, 34], iconAnchor: [17, 34] })
                    });
                }

                var etiqueta = (esVisitado ? "‚úÖ " : "") + i.Cliente;
                marker.bindTooltip(etiqueta, { permanent: true, direction: 'right', className: 'label-boca', offset: [18, -18] });

                var htmlPopup = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h3>${i.Cliente}</h3>
                            <span class="subtitle">${i.Ciudad} (Cod: ${i.CodBoca})</span>
                        </div>
                        <div class="popup-badges">
                            <span class="badge-driver">${i.Chofer}</span>
                            <span class="badge-channel">${i.Transp}</span>
                        </div>
                        <table class="popup-table">
                            <tr><td>Entregas</td><td>${i._c}</td></tr>
                            <tr><td>Peso</td><td>${i._peso.toFixed(2)} Kg</td></tr>
                            <tr><td>Total</td><td class="val-total">Gs. ${formatoDinero.format(i._imp)}</td></tr>
                            <tr><td>Facturas</td><td style="font-size:9px; color:#9ca3af">${i._f.slice(0,3).join(", ")}</td></tr>
                        </table>
                        <button onclick="toggleVisitado('${i.CodBoca}')" class="btn-visit-action ${esVisitado ? 'active' : ''}">
                            ${esVisitado ? 'Remover Visita' : 'Confirmar Visita'}
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="nav-btn-footer">IR AHORA</a>
                    </div>
                `;
                marker.bindPopup(htmlPopup);
                layerGroup.addLayer(marker);
            });
            document.getElementById("contador").innerText = Object.keys(grupos).length + " Entregas";
        };

        function generarPanelColores(l) {
            var c = document.getElementById("lista-colores");
            c.innerHTML = '<span class="label-filter" style="margin-top:10px">Colores Chofer</span>';
            l.forEach(ch => {
                var r = document.createElement("div"); r.className = "chofer-row";
                r.innerHTML = `<span>${ch}</span> <input type="color" value="${coloresMemoria[ch] || COLOR_PREDETERMINADO}" onchange="guardarColor('${ch}', this.value)">`;
                c.appendChild(r);
            });
        }

        function guardarColor(ch, co) {
            coloresMemoria[ch] = co; 
            localStorage.setItem('coloresLogisticaV10', JSON.stringify(coloresMemoria));
            actualizarMapa();
        }

        function togglePanel() { 
            var p = document.getElementById("panel-config"); 
            p.style.display = (p.style.display === "none" || p.style.display === "") ? "flex" : "none"; 
        }
    </script>
</body>
</html>

