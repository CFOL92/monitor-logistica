<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Master-Control-Flota | Sistema M√°ster</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f4f4f4; }
        #map { height: 100vh; width: 100%; background: #cbd5e1; }

        /* --- CONTROLES --- */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.98); padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); width: 220px; 
            display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .label-filter { font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; 
            width: 100%; font-size: 12px; background-color: #fff; color: #1e293b;
            cursor: pointer; transition: border-color 0.2s;
        }

        .btn-config { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .btn-gps { background: #25D366; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #contador { font-size: 10px; text-align: center; color: #64748b; margin-top: 4px; font-weight: 500; }
        #db-status { font-size: 8px; text-align: center; color: #94a3b8; text-transform: uppercase; margin-top: 2px; font-weight: 700; }

        /* --- ETIQUETAS MAPA --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-size: 10px; font-weight: 600 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper { border-radius: 4px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        
        .popup-container { background: white; }
        .popup-header { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .popup-header h3 { margin: 0; color: #333; font-size: 14px; font-weight: 800; text-transform: uppercase; line-height: 1.2; }
        .popup-header .subtitle { color: #888; font-size: 10px; font-weight: 500; display: block; margin-top: 2px; }

        .popup-badges { padding: 10px 15px; display: flex; flex-direction: column; gap: 4px; }
        .badge-driver { background: #00f2a1; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 800; text-transform: uppercase; width: fit-content; }
        .badge-channel { background: #555; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; width: fit-content; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; }
        .popup-table tr td { padding: 8px 15px; border-bottom: 1px solid #f8f8f8; }
        .popup-table tr td:first-child { background: #fafafa; color: #777; font-weight: 500; width: 45%; }
        .popup-table tr td:last-child { text-align: right; color: #333; font-weight: 600; }
        .popup-table .val-total { color: #0078d4 !important; font-weight: 800 !important; font-size: 13px; }

        .btn-visit-action { 
            width: 100%; border: none; padding: 12px; font-size: 11px; font-weight: 700; 
            text-transform: uppercase; cursor: pointer; transition: 0.2s;
            background: #f1f5f9; color: #475569; border-top: 1px solid #eee;
        }
        .btn-visit-action.active { background: #e2e8f0; color: #1e293b; text-decoration: line-through; }
        .btn-visit-action:disabled { opacity: 0.5; cursor: not-allowed; }

        .nav-btn-footer { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: #2ecc71; color: white; text-align: center; padding: 14px; 
            text-decoration: none; font-weight: 700; font-size: 14px;
        }

        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
        
        #panel-config { 
            display: none; position: absolute; top: 10px; left: 10px; z-index: 1001; 
            background: white; width: 280px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); flex-direction: column; 
        }
        .panel-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #0078d4; color: white; border-radius: 12px 12px 0 0; }
        .panel-body { padding: 15px; max-height: 70vh; overflow-y: auto; }
        .chofer-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="window.activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">Transportadora</span>
            <select id="filtroTransp" onchange="window.cambioTransportadora()">
                <option value="todos">Cargando...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">Chofer</span>
            <select id="filtroChofer" onchange="window.actualizarMapa()">
                <option value="todos">...</option>
            </select>
        </div>
        <button class="btn-config" onclick="window.togglePanel()">‚öôÔ∏è CONFIGURACI√ìN</button>
        <div id="contador">Sincronizando...</div>
        <div id="db-status">Nube: Desconectado</div>
    </div>

    <div id="panel-config">
        <div class="panel-header"><strong>MASTER CONTROL FLOTA</strong> <button onclick="window.togglePanel()" style="border:none;background:none;cursor:pointer;color:white;font-size:20px;">√ó</button></div>
        <div class="panel-body">
            <span class="label-filter">Dise√±o de Icono</span>
            <select id="selectIcono" onchange="window.cambiarTipoIcono(this.value)" style="margin-bottom:15px">
                <option value="pin">Pin Profesional</option>
                <option value="circle">Punto Circular</option>
            </select>
            <div id="lista-colores"><span class="label-filter">Personalizar Colores</span></div>
            <button onclick="window.borrarVisitas()" style="width:100%; margin-top:20px; padding:12px; font-size:10px; background:#fef2f2; color:#b91c1c; border:1px solid #fee2e2; border-radius:6px; cursor:pointer; font-weight:800;">RESETEAR VISITAS (ADMIN)</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE TU PROYECTO ---
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const COLOR_PREDETERMINADO = "#0ea5e9"; 
        const COLOR_VISITADO = "#64748b"; 
        const appId = 'master-control-flota';

        // TUS CLAVES REALES DE FIREBASE (Verificadas)
        const myFirebaseConfig = {
            apiKey: "AIzaSyAcNUSS0zgcCtqpyJf5E76WWSGuXPbqa88",
            authDomain: "master-control-flota.firebaseapp.com",
            projectId: "master-control-flota",
            storageBucket: "master-control-flota.firebasestorage.app",
            messagingSenderId: "102366703423",
            appId: "1:102366703423:web:486d885f846cc2f82fad8a",
            measurementId: "G-T3NHDNL2E9"
        };

        window.visitasMemoria = {};
        window.datosGlobales = [];
        window.coloresMemoria = JSON.parse(localStorage.getItem('coloresLogisticaV10') || '{}');
        window.tipoIconoGlobal = localStorage.getItem('tipoIconoV10') || 'pin';
        let db = null, auth = null, currentUser = null;

        // --- MAPA ---
        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);
        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        window.togglePanel = () => {
            const p = document.getElementById("panel-config");
            p.style.display = (p.style.display === "none" || p.style.display === "") ? "flex" : "none";
        };

        window.cambiarTipoIcono = (val) => {
            window.tipoIconoGlobal = val;
            localStorage.setItem('tipoIconoV10', val);
            window.actualizarMapa();
        };

        window.activarGPS = () => {
            document.getElementById("contador").innerText = "Ubicando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        };

        map.on('locationfound', (e) => {
            L.circle(e.latlng, e.accuracy/2, {color: '#22c55e', weight:1, fillOpacity: 0.1}).addTo(map);
            L.marker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
            document.getElementById("contador").innerText = "GPS Activo";
        });

        map.on('zoomend', () => {
            const z = map.getZoom();
            document.body.classList.toggle('zoom-high', z >= 14);
            document.body.classList.toggle('zoom-low', z < 14);
        });

        // --- MOTOR DE PROCESAMIENTO DE DATOS ---
        function getVal(obj, keys) {
            if(!obj) return null;
            const objKeys = Object.keys(obj);
            for (let k of keys) {
                // Limpieza profunda para detectar columnas con caracteres especiales como '/'
                const searchKey = k.toLowerCase().replace(/[\s\._\/]/g, '');
                const found = objKeys.find(ok => ok.toLowerCase().replace(/[\s\._\/]/g, '') === searchKey);
                if (found && obj[found] !== undefined && obj[found] !== null && obj[found] !== "") return obj[found];
            }
            return null;
        }

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[^0-9,.-]/g, "");
            
            // Caso: 1,231,126 (Comas para miles como se ve en image_add047.png)
            if (str.includes(',') && !str.includes('.')) {
                const parts = str.split(',');
                if (parts.length > 1 && parts[parts.length-1].length === 3) str = str.replace(/,/g, ""); 
                else if (parts.length === 2) str = str.replace(',', '.'); 
            } else if (str.includes(',') && str.includes('.')) {
                if (str.lastIndexOf(',') > str.lastIndexOf('.')) str = str.replace(/\./g, "").replace(',', '.');
                else str = str.replace(/,/g, ""); 
            } else if (str.includes('.')) {
                const parts = str.split('.');
                if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3 && parseFloat(str) < 1000)) str = str.replace(/\./g, "");
            }
            const res = parseFloat(str);
            return isNaN(res) ? 0 : res;
        }

        async function cargarDatosExcel() {
            try {
                const response = await fetch(SHEET_API);
                const data = await response.json();
                window.datosGlobales = data;
                inicializarFiltros(data);
                window.actualizarMapa(true);
            } catch (e) {
                document.getElementById("contador").innerText = "Error Excel";
            }
        }

        function inicializarFiltros(data) {
            const transportistas = [...new Set(data.map(d => getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T"))].filter(Boolean).sort();
            llenarSelect("filtroTransp", transportistas, "TODAS LAS TRANSPORTADORAS");
            const choferes = [...new Set(data.map(d => getVal(d, ["Chofer", "Suma de Chofer"]) || "S/C"))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS LOS CHOFERES");
            generarPanelColores(choferes);
        }

        function llenarSelect(id, lista, titulo) {
            const s = document.getElementById(id);
            if(!s) return;
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => {
                const op = document.createElement("option"); op.value = i; op.innerText = i; s.appendChild(op);
            });
        }

        window.cambioTransportadora = () => {
            const t = document.getElementById("filtroTransp").value;
            const filtrados = (t === "todos") ? window.datosGlobales : window.datosGlobales.filter(d => (getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T") === t);
            const choferes = [...new Set(filtrados.map(d => getVal(d, ["Chofer", "Suma de Chofer"]) || "S/C"))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS LOS CHOFERES");
            window.actualizarMapa();
        };

        window.actualizarMapa = (fit = false) => {
            if (!layerGroup || !window.datosGlobales || !window.datosGlobales.length) return;
            layerGroup.clearLayers();
            const selTransp = document.getElementById("filtroTransp").value;
            const selChofer = document.getElementById("filtroChofer").value;
            const bounds = [];
            const grupos = {};

            window.datosGlobales.forEach(i => {
                const chofer = getVal(i, ["Chofer", "Suma de Chofer"]) || "S/C";
                const transp = getVal(i, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T";
                if (selTransp !== "todos" && transp !== selTransp) return;
                if (selChofer !== "todos" && chofer !== selChofer) return;

                const lat = parseFloat(String(getVal(i, ["Latitud", "Lat", "Suma de Latitud"]) || "").replace(',', '.').trim());
                const lon = parseFloat(String(getVal(i, ["Longitud", "Lon", "Suma de Longitud"]) || "").replace(',', '.').trim());
                if (isNaN(lat) || isNaN(lon)) return;

                const codBoca = getVal(i, ["CodBoca", "C√≥d. Boca", "Suma de CodBoca"]);
                const pointId = codBoca ? String(codBoca).trim() : `pos_${lat}_${lon}`;
                const key = chofer + "_" + pointId;
                
                if (!grupos[key]) {
                    grupos[key] = { 
                        ...i, _id: pointId, _lat: lat, _lon: lon, _f: new Set(), _p: new Set(), _peso: 0, _imp: 0, _c: 0,
                        _nombre: getVal(i, ["Cliente", "Boca", "Nombre Cliente", "Suma de Boca", "Suma de Cliente"]) || "SIN NOMBRE",
                        _transp: transp, _codBoca: codBoca || 'N/A',
                        _estadoExcel: getVal(i, ["Estado", "Status"])
                    };
                }
                
                const f = getVal(i, ["NumFactura", "Suma de NumFactura"]); if(f) grupos[key]._f.add(f);
                const p = getVal(i, ["Pedido", "Suma de Pedido"]); if(p) grupos[key]._p.add(p);
                
                // SUMATORIA DE PESO E IMPORTE (Corregido para tus columnas)
                grupos[key]._peso += parseNum(getVal(i, ["Suma de Peso Total", "Peso"]));
                const valImporte = getVal(i, ["Suma de ImportePedidos/IVA", "Suma de ImportePedidos", "Importe", "ImporteTotal", "Total Gs"]);
                grupos[key]._imp += parseNum(valImporte);
                grupos[key]._c++;
            });

            Object.values(grupos).forEach(i => {
                // PERSISTENCIA: Mira estado en Excel O Firebase
                const esVisitado = (i._estadoExcel === "Visitado") || (!!window.visitasMemoria[i._id]);
                const usaColorChofer = (selTransp !== "todos" || selChofer !== "todos");
                const colorBase = usaColorChofer ? (window.coloresMemoria[getVal(i, ["Chofer", "Suma de Chofer"])] || COLOR_PREDETERMINADO) : COLOR_PREDETERMINADO;
                const colorActual = esVisitado ? COLOR_VISITADO : colorBase;
                
                let marker;
                if (window.tipoIconoGlobal === "circle") {
                    marker = L.circleMarker([i._lat, i._lon], { radius: 8, fillColor: colorActual, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 });
                } else {
                    marker = L.marker([i._lat, i._lon], {
                        icon: L.divIcon({ className: 'custom-div-icon', html: getPinSvg(colorActual), iconSize: [34, 34], iconAnchor: [17, 34] })
                    });
                }

                marker.bindTooltip((esVisitado ? "‚úÖ " : "") + i._nombre, { permanent: true, direction: 'right', className: 'label-boca', offset: [18, -18] });

                const htmlPopup = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h3>${i._nombre}</h3>
                            <span class="subtitle">${i.Ciudad || ''} (Cod: ${i._codBoca})</span>
                        </div>
                        <div class="popup-badges">
                            <span class="badge-driver">${getVal(i, ["Chofer", "Suma de Chofer"]) || 'S/C'}</span>
                            <span class="badge-channel">${i._transp}</span>
                        </div>
                        <table class="popup-table">
                            <tr><td>Entregas</td><td>${i._c}</td></tr>
                            <tr><td>Peso Total</td><td>${i._peso.toFixed(2)} Kg</td></tr>
                            <tr><td>Total Gs.</td><td class="val-total">Gs. ${formatoDinero.format(i._imp)}</td></tr>
                            <tr><td>Facturas</td><td style="font-size:9px; color:#9ca3af">${Array.from(i._f).join(", ")}</td></tr>
                            <tr><td>Pedidos</td><td style="font-size:9px; color:#9ca3af">${Array.from(i._p).join(", ")}</td></tr>
                        </table>
                        <button id="btn-${i._id}" onclick="window.toggleVisitado('${i._id}')" class="btn-visit-action ${esVisitado ? 'active' : ''}">
                            ${esVisitado ? 'REMOVER VISITA' : 'CONFIRMAR VISITA'}
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${i._lat},${i._lon}" target="_blank" class="nav-btn-footer">IR AHORA</a>
                    </div>
                `;
                marker.bindPopup(htmlPopup).addTo(layerGroup);
                bounds.push([i._lat, i._lon]);
            });

            if (fit && bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            document.getElementById("contador").innerText = Object.keys(grupos).length + " Puntos Cargados";
        };

        const initFirebase = async () => {
            try {
                const appInstance = initializeApp(myFirebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        document.getElementById("db-status").innerText = "Nube: Conectado";
                        startRealtimeSync();
                        cargarDatosExcel();
                    }
                });
                await initAuth();
            } catch(e) { 
                console.error("Error Firebase:", e);
                document.getElementById("db-status").innerText = "Nube: Error";
                cargarDatosExcel(); 
            }
        };

        function startRealtimeSync() {
            if (!db || !currentUser) return;
            const visitasRef = collection(db, 'artifacts', appId, 'public', 'data', 'visitas');
            onSnapshot(visitasRef, (snapshot) => {
                window.visitasMemoria = {};
                snapshot.forEach((doc) => { window.visitasMemoria[doc.id] = doc.data().visitado; });
                window.actualizarMapa();
            }, (err) => {
                document.getElementById("db-status").innerText = "Nube: Sin Permiso";
            });
        }

        window.toggleVisitado = async (id) => {
            const currentStatus = (window.visitasMemoria[id] === true);
            const newStatus = !currentStatus;
            
            const btn = document.getElementById(`btn-${id}`);
            if(btn) {
                btn.disabled = true;
                btn.innerText = "PROCESANDO...";
            }

            // FEEDBACK VISUAL LOCAL INMEDIATO
            window.visitasMemoria[id] = newStatus;
            window.actualizarMapa();
            
            if (currentUser && db) {
                try {
                    const visitDoc = doc(db, 'artifacts', appId, 'public', 'data', 'visitas', String(id));
                    await setDoc(visitDoc, { visitado: newStatus, timestamp: new Date() });
                } catch(e) { console.error("Error Nube", e); }
            }
            
            const labelStatus = newStatus ? 'Visitado' : 'Pendiente';
            const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(id)}&status=${encodeURIComponent(labelStatus)}`;
            
            fetch(updateUrl, { mode: 'no-cors' })
                .catch(err => console.error("Error Excel:", err))
                .finally(() => {
                    if(btn) btn.disabled = false;
                    map.closePopup();
                });
        };

        window.borrarVisitas = async () => {
            const input = prompt("PIN Administrador:");
            if (input === "1234" && confirm("¬øBorrar todas las visitas?")) {
                if (db && currentUser) {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'visitas'));
                    const delArr = [];
                    snap.forEach((d) => delArr.push(deleteDoc(d.ref)));
                    await Promise.all(delArr);
                }
                window.visitasMemoria = {};
                window.actualizarMapa();
                alert("Mapa reiniciado.");
            }
        };

        function getPinSvg(color) {
            return `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4))">
                <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${color}"/>
                <circle cx="12" cy="9" r="3.5" fill="white"/>
            </svg>`;
        }

        function generarPanelColores(l) {
            const c = document.getElementById("lista-colores");
            if (!c) return;
            c.innerHTML = '<span class="label-filter" style="margin-top:10px">Personalizar Colores</span>';
            l.forEach(ch => {
                const r = document.createElement("div"); r.className = "chofer-row";
                r.innerHTML = `<span>${ch}</span> <input type="color" value="${window.coloresMemoria[ch] || COLOR_PREDETERMINADO}" onchange="window.guardarColor('${ch}', this.value)">`;
                c.appendChild(r);
            });
        }

        window.guardarColor = (ch, co) => {
            window.coloresMemoria[ch] = co; 
            localStorage.setItem('coloresLogisticaV10', JSON.stringify(window.coloresMemoria));
            window.actualizarMapa();
        };

        initFirebase();
    </script>
</body>
</html>
