<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Master-Control-Flota | Sistema M√°ster</title>
    
    <!-- Leaflet para el Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0284c7;
            --success: #22c55e;
            --success-dark: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --neutral: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f1f5f9; }
        #map { height: 100vh; width: 100%; background: #cbd5e1; }

        /* --- PANEL DE CONTROLES --- */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: var(--bg-glass); padding: 12px; border-radius: 12px;
            box-shadow: var(--shadow); width: 230px; 
            display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .label-filter { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; 
            width: 100%; font-size: 12px; background-color: #fff; color: #1e293b;
            cursor: pointer; transition: border-color 0.2s;
        }

        .btn-config { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-gps { background: var(--success); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #contador { font-size: 10px; text-align: center; color: #64748b; margin-top: 4px; font-weight: 600; }
        #db-status { font-size: 8px; text-align: center; color: #94a3b8; text-transform: uppercase; margin-top: 2px; font-weight: 800; letter-spacing: 0.4px; line-height: 1.2; }

        /* --- ETIQUETAS DEL MAPA CON SEM√ÅFORO --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-size: 10px; font-weight: 700 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.3s ease; pointer-events: none;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        .semaphore-container { display: flex; gap: 2px; margin-top: 2px; }
        .semaphore-dot { width: 8px; height: 8px; border-radius: 50%; border: 1px solid white; }
        .dot-entregado { background-color: var(--success); }
        .dot-parcial { background-color: var(--warning); }
        .dot-rechazado { background-color: var(--danger); }
        .dot-nodespachado { background-color: var(--neutral); }
        .dot-pendiente { background-color: var(--primary); }

        /* --- POPUP PROFESIONAL --- */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border: 1px solid #ddd; }
        .leaflet-popup-content { margin: 0 !important; width: 300px !important; }
        
        .popup-container { background: white; display: flex; flex-direction: column; }
        .popup-header { padding: 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .popup-header h3 { margin: 0; color: #111; font-size: 14px; font-weight: 900; text-transform: uppercase; line-height: 1.2; }
        .popup-header .subtitle { color: #64748b; font-size: 10px; font-weight: 600; display: block; margin-top: 4px; }

        .popup-section-title { font-size: 9px; font-weight: 800; color: #94a3b8; padding: 10px 15px 4px 15px; text-transform: uppercase; letter-spacing: 0.5px; background: #f8fafc; }

        /* --- LISTADO DE FACTURAS --- */
        .facturas-list-container { padding: 5px 0; background: #f8fafc; max-height: 200px; overflow-y: auto; border-bottom: 1px solid #f1f5f9; }
        .factura-row { padding: 12px 15px; border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; gap: 8px; }
        .factura-row:last-child { border-bottom: none; }
        .factura-header-info { display: flex; justify-content: space-between; align-items: center; }
        .factura-id { font-size: 11px; font-weight: 800; color: #334155; }
        .factura-status-badge { font-size: 8px; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: white; }
        
        .status-btn-group { display: flex; gap: 4px; }
        .btn-factura-status { 
            flex: 1; border: 1px solid #e2e8f0; padding: 6px; border-radius: 4px; font-size: 8px; 
            font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.2s; 
            background: white; color: #64748b;
        }
        .btn-factura-status.active-entregado { background: var(--success); color: white; border-color: var(--success-dark); }
        .btn-factura-status.active-parcial { background: var(--warning); color: white; border-color: #d97706; }
        .btn-factura-status.active-rechazado { background: var(--danger); color: white; border-color: #dc2626; }
        .btn-factura-status.active-nodespachado { background: var(--neutral); color: white; border-color: #475569; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .popup-table tr td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; }
        .popup-table tr td:first-child { color: #64748b; font-weight: 500; width: 45%; }
        .popup-table tr td:last-child { text-align: right; color: #1e293b; font-weight: 700; }
        
        .val-total { color: #0284c7 !important; font-size: 14px; font-weight: 900 !important; }
        .val-peso { color: #f59e0b !important; }

        .btn-unconfirm-all { 
            width: 100%; border: none; padding: 12px; font-size: 10px; font-weight: 800; 
            color: #ef4444; background: #fff; cursor: pointer; text-decoration: none; border-top: 1px solid #f1f5f9;
        }

        .nav-btn-footer { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--success); color: white; text-align: center; padding: 16px; 
            text-decoration: none; font-weight: 800; font-size: 13px; letter-spacing: 0.5px;
        }

        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="window.activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">TRANSPORTADORA</span>
            <select id="filtroTransp" onchange="window.cambioTransportadora()">
                <option value="todos">CARGANDO...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">CHOFER</span>
            <select id="filtroChofer" onchange="window.actualizarMapa()">
                <option value="todos">TODOS LOS CHOFERES</option>
            </select>
        </div>
        <button class="btn-config" onclick="window.togglePanel()">‚öôÔ∏è CONFIGURACI√ìN</button>
        <div id="contador">Sincronizando...</div>
        <div id="db-status">NUBE: CONECTANDO...</div>
    </div>

    <div id="panel-config" style="display:none;">
        <div class="panel-header"><strong>CONFIGURACIONES</strong> <button onclick="window.togglePanel()" style="border:none;background:none;cursor:pointer;color:white;font-size:20px;">√ó</button></div>
        <div class="panel-body">
            <span class="label-filter">Dise√±o del √çcono</span>
            <select id="selectIcono" onchange="window.cambiarTipoIcono(this.value)" style="margin-bottom:15px">
                <option value="pin">Pin Profesional</option>
                <option value="circle">Punto Circular</option>
            </select>
            <button onclick="window.borrarVisitas()" style="width:100%; margin-top:20px; padding:12px; font-size:10px; background:#fef2f2; color:#b91c1c; border:1px solid #fee2e2; border-radius:6px; cursor:pointer; font-weight:800;">REINICIAR VISITAS (ADMIN)</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp, deleteApp, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACI√ìN MAESTRA ---
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const COLOR_PREDETERMINADO = "#0ea5e9"; 
        const COLOR_VISITADO = "#64748b"; 
        const appIdInterno = 'master-control-flota'; 

        const myFirebaseConfig = {
            apiKey: "AIzaSyCPPLoQOVvEsTV8p6SAynsLqfsvvmxZ8wA", // Credencial definitiva confirmada
            authDomain: "master-control-flota.firebaseapp.com",
            projectId: "master-control-flota",
            storageBucket: "master-control-flota.firebasestorage.app",
            messagingSenderId: "102366703423",
            appId: "1:102366703423:web:486d885f846cc2f82fad8a",
            measurementId: "G-T3NHDNL2E9"
        };

        window.visitasMemoria = {};
        window.datosGlobales = [];
        window.tipoIconoGlobal = localStorage.getItem('tipoIconoV10') || 'pin';
        let db = null, auth = null, currentUser = null;

        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);
        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', () => {
            const z = map.getZoom();
            document.body.classList.toggle('zoom-high', z >= 14);
            document.body.classList.toggle('zoom-low', z < 14);
        });

        window.togglePanel = () => {
            const p = document.getElementById("panel-config");
            if(p) p.style.display = (p.style.display === "none" || p.style.display === "") ? "flex" : "none";
        };

        window.cambiarTipoIcono = (val) => {
            window.tipoIconoGlobal = val;
            localStorage.setItem('tipoIconoV10', val);
            window.actualizarMapa();
        };

        window.activarGPS = () => {
            const contadorEl = document.getElementById("contador");
            if(contadorEl) contadorEl.innerText = "Ubicando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        };

        map.on('locationfound', (e) => {
            L.circle(e.latlng, e.accuracy/2, {color: '#22c55e', weight:1, fillOpacity: 0.1}).addTo(map);
            L.marker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
        });

        function getVal(obj, keys) {
            if(!obj) return null;
            const objKeys = Object.keys(obj);
            for (let k of keys) {
                const searchKey = k.toLowerCase().replace(/[\s\._\/]/g, '');
                const foundKey = objKeys.find(ok => ok.toLowerCase().replace(/[\s\._\/]/g, '') === searchKey);
                if (foundKey && obj[foundKey] !== undefined && obj[foundKey] !== null && obj[foundKey] !== "") {
                    return obj[foundKey];
                }
            }
            return null;
        }

        function normalizeString(val) {
            if (!val) return "";
            return String(val).trim().toUpperCase();
        }

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[^0-9,.-]/g, "");
            if (str.includes(',') && !str.includes('.')) {
                const parts = str.split(',');
                if (parts.length > 1 && parts[parts.length-1].length === 3) str = str.replace(/,/g, ""); 
                else if (parts.length === 2) str = str.replace(',', '.'); 
            } else if (str.includes(',') && str.includes('.')) {
                if (str.lastIndexOf(',') > str.lastIndexOf('.')) str = str.replace(/\./g, "").replace(',', '.');
                else str = str.replace(/,/g, ""); 
            } else if (str.includes('.')) {
                const parts = str.split('.');
                if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3 && parseFloat(str) < 1000)) str = str.replace(/\./g, "");
            }
            const res = parseFloat(str);
            return isNaN(res) ? 0 : res;
        }

        async function cargarDatosExcel() {
            try {
                const response = await fetch(SHEET_API);
                const rawData = await response.json();
                window.datosGlobales = rawData.map(d => {
                    const transp = getVal(d, ["Transp", "Transportadora", "Suma de Transportista", "Transportista"]) || "S/T";
                    const chofer = getVal(d, ["Chofer", "Suma de Chofer"]) || "S/C";
                    return {
                        ...d,
                        _transp_limpia: normalizeString(transp),
                        _chofer_limpio: normalizeString(chofer),
                        _transp_original: String(transp).trim(),
                        _chofer_original: String(chofer).trim()
                    };
                });
                const transportistasSet = new Set();
                window.datosGlobales.forEach(d => transportistasSet.add(d._transp_original));
                llenarSelect("filtroTransp", Array.from(transportistasSet).sort(), "TODAS LAS TRANSPORTADORAS");
                window.cambioTransportadora(); 
                window.actualizarMapa(true);
            } catch (e) { console.error("Error Excel:", e); }
        }

        function llenarSelect(id, lista, titulo) {
            const s = document.getElementById(id);
            if(!s) return;
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => {
                const op = document.createElement("option"); 
                op.value = i; op.innerText = i; s.appendChild(op);
            });
        }

        window.cambioTransportadora = () => {
            const valTransp = document.getElementById("filtroTransp").value;
            const selTranspNorm = normalizeString(valTransp);
            const choferesSet = new Set();
            window.datosGlobales.forEach(d => {
                if (valTransp === "todos" || d._transp_limpia === selTranspNorm) {
                    choferesSet.add(d._chofer_original);
                }
            });
            llenarSelect("filtroChofer", Array.from(choferesSet).sort(), "TODOS LOS CHOFERES");
            document.getElementById("filtroChofer").value = "todos"; 
            window.actualizarMapa();
        };

        window.actualizarMapa = (fit = false) => {
            if (!layerGroup || !window.datosGlobales.length) return;
            layerGroup.clearLayers();
            const valTransp = document.getElementById("filtroTransp").value;
            const valChofer = document.getElementById("filtroChofer").value;
            const selTranspNorm = normalizeString(valTransp);
            const selChoferNorm = normalizeString(valChofer);
            const bounds = [];
            const grupos = {};

            window.datosGlobales.forEach(i => {
                const cumpleTransp = (valTransp === "todos") || (i._transp_limpia === selTranspNorm);
                const cumpleChofer = (valChofer === "todos") || (i._chofer_limpio === selChoferNorm);
                if (!cumpleTransp || !cumpleChofer) return;

                const latRaw = getVal(i, ["Latitud", "Lat", "Suma de Latitud"]);
                const lonRaw = getVal(i, ["Longitud", "Lon", "Suma de Longitud"]);
                if (!latRaw || !lonRaw) return;
                const lat = parseFloat(String(latRaw).replace(',', '.').trim());
                const lon = parseFloat(String(lonRaw).replace(',', '.').trim());
                if (isNaN(lat) || isNaN(lon)) return;

                const idBocaRaw = getVal(i, ["CodBoca", "C√≥d. Boca", "Suma de CodBoca"]);
                const idBoca = idBocaRaw ? String(idBocaRaw).trim() : `pos_${lat}_${lon}`;
                
                if (!grupos[idBoca]) {
                    grupos[idBoca] = { 
                        lat, lon, id: idBoca, 
                        cliente: getVal(i, ["Cliente", "Boca", "Nombre Cliente", "Suma de Boca", "Suma de Cliente"]) || "SIN NOMBRE",
                        ciudad: getVal(i, ["Ciudad"]) || "S/C",
                        choferDisplay: i._chofer_original,
                        facturas: new Set(), pesoTotal: 0, montoTotal: 0
                    };
                }
                const factura = getVal(i, ["NumFactura", "Suma de NumFactura", "Factura"]);
                if(factura) grupos[idBoca].facturas.add(String(factura).trim());
                grupos[idBoca].pesoTotal += parseNum(getVal(i, ["Suma de Peso Total", "Peso Total", "Peso"]));
                grupos[idBoca].montoTotal += parseNum(getVal(i, ["Suma de ImportePedidos/IVA", "Importe", "ImporteTotal"]));
                bounds.push([lat, lon]);
            });

            Object.values(grupos).forEach(g => {
                const visitData = window.visitasMemoria[g.id] || { facturas: {} };
                const facturasData = visitData.facturas || {};
                
                // L√ìGICA DE COLOR: Si hay facturas registradas, el pin es GRIS
                const hasBeenProcessed = Object.keys(facturasData).length > 0;
                const colorActual = hasBeenProcessed ? COLOR_VISITADO : COLOR_PREDETERMINADO;
                
                let marker;
                if (window.tipoIconoGlobal === "circle") {
                    marker = L.circleMarker([g.lat, g.lon], { radius: 9, fillColor: colorActual, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 });
                } else {
                    marker = L.marker([g.lat, g.lon], { icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4))">
                            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${colorActual}"/>
                            <circle cx="12" cy="9" r="3.5" fill="white"/>
                        </svg>`,
                        iconSize: [34, 34], iconAnchor: [17, 34]
                    }) });
                }

                // SEM√ÅFORO EN ETIQUETA
                let dotsHtml = "";
                Array.from(g.facturas).forEach(fId => {
                    const fStatus = facturasData[fId] ? facturasData[fId].status : "PENDIENTE";
                    const statusClass = fStatus.toLowerCase().replace(" ", "");
                    dotsHtml += `<div class="semaphore-dot dot-${statusClass}"></div>`;
                });

                marker.bindTooltip(`<div>${(hasBeenProcessed ? "‚úÖ " : "") + g.cliente}<div class="semaphore-container">${dotsHtml}</div></div>`, { 
                    permanent: true, direction: 'right', className: 'label-boca', offset: [15, -15] 
                });

                // FILAS DE FACTURAS EN POPUP
                let facturasRowsHtml = "";
                Array.from(g.facturas).forEach(fId => {
                    const fData = facturasData[fId] || { status: "PENDIENTE", motivo: "" };
                    const status = fData.status;
                    const statusClass = status.toLowerCase().replace(" ", "");
                    
                    facturasRowsHtml += `
                        <div class="factura-row">
                            <div class="factura-header-info">
                                <span class="factura-id">FACT: ${fId}</span>
                                <span class="factura-status-badge dot-${statusClass}">${status}</span>
                            </div>
                            <div class="status-btn-group">
                                <button onclick="window.actualizarFactura('${g.id}', '${fId}', 'ENTREGADO')" class="btn-factura-status ${status==='ENTREGADO'?'active-entregado':''}">Entregado</button>
                                <button onclick="window.actualizarFactura('${g.id}', '${fId}', 'PARCIAL')" class="btn-factura-status ${status==='PARCIAL'?'active-parcial':''}">Parcial</button>
                                <button onclick="window.actualizarFactura('${g.id}', '${fId}', 'RECHAZADO')" class="btn-factura-status ${status==='RECHAZADO'?'active-rechazado':''}">Rechazado</button>
                                <button onclick="window.actualizarFactura('${g.id}', '${fId}', 'NO DESPACHADO')" class="btn-factura-status ${status==='NO DESPACHADO'?'active-nodespachado':''}">No Desp.</button>
                            </div>
                            ${fData.motivo ? `<div style="font-size:9px; color:#64748b; font-style: italic; margin-top:2px;">Motivo: ${fData.motivo}</div>` : ''}
                        </div>
                    `;
                });

                const popupHtml = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h3>${g.cliente}</h3>
                            <span class="subtitle">${g.ciudad} (ID: ${g.id})</span>
                        </div>
                        <div class="popup-section-title">Control por Factura</div>
                        <div class="facturas-list-container">${facturasRowsHtml}</div>
                        <table class="popup-table">
                            <tr><td>Chofer</td><td>${g.choferDisplay}</td></tr>
                            <tr><td>Peso Total</td><td class="val-peso">${g.pesoTotal.toFixed(2)} kg</td></tr>
                            <tr><td>Importe Total</td><td class="val-total">Gs. ${formatoDinero.format(g.montoTotal)}</td></tr>
                        </table>
                        ${hasBeenProcessed ? `<button onclick="window.desmarcarTodo('${g.id}')" class="btn-unconfirm-all">RESETEAR PUNTO DE ENTREGA</button>` : ''}
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${g.lat},${g.lon}" target="_blank" class="nav-btn-footer">IR CON GPS</a>
                    </div>
                `;
                marker.bindPopup(popupHtml).addTo(layerGroup);
            });

            if (fit && bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            document.getElementById("contador").innerText = Object.keys(grupos).length + " Puntos Cargados";
        };

        window.actualizarFactura = async (bocaId, facturaId, nuevoEstado) => {
            let motivo = "";
            if (nuevoEstado !== "ENTREGADO") {
                motivo = prompt(`Ingrese el motivo para la factura ${facturaId} (${nuevoEstado}):`);
                if (motivo === null) return;
            }

            if (!window.visitasMemoria[bocaId]) window.visitasMemoria[bocaId] = { facturas: {} };
            
            // Actualizaci√≥n local
            window.visitasMemoria[bocaId].facturas[facturaId] = { 
                status: nuevoEstado, 
                motivo: motivo,
                timestamp: new Date().toISOString()
            };
            
            window.actualizarMapa();

            try {
                if (currentUser && db) {
                    const docRef = doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(bocaId));
                    await setDoc(docRef, window.visitasMemoria[bocaId]);
                }
                // Sincronizaci√≥n con Excel (Estado y Motivo incluidos)
                const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(bocaId)}&factura=${encodeURIComponent(facturaId)}&status=${encodeURIComponent(nuevoEstado)}&motivo=${encodeURIComponent(motivo)}`;
                fetch(updateUrl, { mode: 'no-cors' });
            } catch(e) { console.error("Error nube:", e); }
        };

        window.desmarcarTodo = async (id) => {
            if(!confirm("¬øBorrar todos los estados guardados de este punto y volverlo a Pendiente (Azul)?")) return;
            
            // Limpieza local
            delete window.visitasMemoria[id];
            window.actualizarMapa();

            try {
                if (currentUser && db) {
                    await deleteDoc(doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(id)));
                }
                // Reset en Excel
                const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(id)}&status=PENDIENTE&motivo=RESET_ALL`;
                fetch(updateUrl, { mode: 'no-cors' }).finally(() => map.closePopup());
            } catch(e) { console.error(e); }
        };

        // --- FIREBASE (PROTOCOLO BLINDADO ANTI-ERROR AUTH) ---
        const initFirebase = async () => {
            const statusEl = document.getElementById("db-status");
            try {
                // Borrar instancia previa para forzar limpieza de sesiones corruptas
                try { 
                    const oldApp = getApp(); 
                    if(oldApp) await deleteApp(oldApp); 
                } catch(e) {}

                const appInstance = initializeApp(myFirebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        statusEl.innerText = "NUBE: CONECTADO"; statusEl.style.color = "#0284c7";
                        
                        // Escucha en tiempo real de cambios en la nube
                        onSnapshot(collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas'), (snap) => {
                            snap.docChanges().forEach(c => {
                                window.visitasMemoria[c.doc.id] = c.doc.data();
                            });
                            window.actualizarMapa();
                        }, (error) => {
                            console.error("Error en Snapshot:", error);
                            statusEl.innerText = "NUBE: ERROR PERMISOS";
                        });
                        
                        cargarDatosExcel();
                    } else {
                        statusEl.innerText = "NUBE: AUTENTICANDO...";
                        try { 
                            await signInAnonymously(auth); 
                        } catch(err) {
                            console.error("Error en signIn:", err);
                            statusEl.innerText = "NUBE: ERROR (" + err.code.toUpperCase() + ")"; 
                            statusEl.style.color = "#ef4444";
                            cargarDatosExcel();
                        }
                    }
                });
            } catch(e) { 
                console.error("Fallo cr√≠tico:", e);
                statusEl.innerText = "NUBE: ERROR INICIALIZACI√ìN"; 
                cargarDatosExcel(); 
            }
        };

        window.borrarVisitas = async () => {
            const pin = prompt("PIN Administrador:");
            if (pin === "1234" && confirm("¬øBORRAR PERMANENTEMENTE TODAS LAS VISITAS?")) {
                if (db && currentUser) {
                    const snap = await getDocs(collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas'));
                    const delArr = [];
                    snap.forEach((d) => delArr.push(deleteDoc(d.ref)));
                    await Promise.all(delArr);
                    window.visitasMemoria = {}; window.actualizarMapa();
                    alert("Base de datos reiniciada con √©xito.");
                }
            }
        };

        initFirebase();
    </script>
</body>
</html>
