<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Master Control Flota | LogiTrack Pro</title>
    
    <!-- Leaflet Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0284c7;
            --success: #22c55e;
            --success-dark: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --neutral: #64748b;
            --bg-glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f1f5f9; }
        #map { height: 100vh; width: 100%; background: #cbd5e1; }

        /* --- CONTROLES SUPERIORES --- */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: var(--bg-glass); padding: 12px; border-radius: 12px;
            box-shadow: var(--shadow); width: 240px; 
            display: flex; flex-direction: column; gap: 10px; border: 1px solid #e2e8f0;
        }
        
        .label-filter { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; 
            width: 100%; font-size: 12px; background-color: #fff; color: #1e293b;
            cursor: pointer;
        }

        .btn-gps { background: var(--success); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s; }
        .btn-gps:hover { background: var(--success-dark); }
        .btn-config { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; }

        #contador { font-size: 10px; text-align: center; color: #64748b; margin-top: 4px; font-weight: 600; }
        #db-status { font-size: 8px; text-align: center; color: #94a3b8; text-transform: uppercase; margin-top: 2px; font-weight: 800; cursor: pointer; user-select: none; transition: color 0.3s; }

        /* --- SEM√ÅFOROS Y ETIQUETAS --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-size: 10px; font-weight: 700 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        .semaphore-container { display: flex; gap: 2px; margin-top: 2px; }
        .semaphore-dot { width: 8px; height: 8px; border-radius: 50%; border: 1px solid white; }
        .dot-entregado { background-color: var(--success); }
        .dot-parcial { background-color: var(--warning); }
        .dot-rechazado { background-color: var(--danger); }
        .dot-nodespachado { background-color: var(--neutral); }
        .dot-pendiente { background-color: var(--primary); }

        /* --- POPUP PROFESIONAL --- */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border: 1px solid #ddd; }
        .leaflet-popup-content { margin: 0 !important; width: 330px !important; }
        
        .popup-container { background: white; display: flex; flex-direction: column; }
        .popup-header { padding: 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .popup-header h3 { margin: 0; color: #111; font-size: 14px; font-weight: 900; text-transform: uppercase; line-height: 1.2; }
        .popup-header .subtitle { color: #64748b; font-size: 10px; font-weight: 600; display: block; margin-top: 4px; }

        .popup-section-title { font-size: 9px; font-weight: 800; color: #94a3b8; padding: 10px 15px 4px 15px; text-transform: uppercase; background: #f8fafc; }

        .facturas-list-container { padding: 5px 0; background: #f8fafc; max-height: 250px; overflow-y: auto; border-bottom: 1px solid #f1f5f9; }
        .factura-row { padding: 12px 15px; border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; gap: 8px; }
        .factura-header-info { display: flex; justify-content: space-between; align-items: center; }
        .factura-status-badge { font-size: 8px; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: white; }
        
        .status-btn-group { 
            display: flex !important;
            flex-direction: row !important;
            justify-content: space-between !important;
            gap: 4px !important; 
            margin-top: 8px !important; 
            width: 100% !important;
        }
        .btn-factura-status { 
            flex: 1;
            border: 1px solid #e2e8f0; 
            padding: 8px 1px; 
            border-radius: 4px; 
            font-size: 6.5px; 
            font-weight: 900; 
            text-transform: uppercase; 
            cursor: pointer !important; 
            transition: 0.2s; 
            background: white; 
            color: #64748b;
            text-align: center;
            white-space: nowrap;
            pointer-events: auto !important;
        }
        .btn-factura-status:active { transform: scale(0.92); }
        .btn-factura-status.active-entregado { background: var(--success); color: white; border-color: var(--success-dark); }
        .btn-factura-status.active-parcial { background: var(--warning); color: white; border-color: #d97706; }
        .btn-factura-status.active-rechazado { background: var(--danger); color: white; border-color: #dc2626; }
        .btn-factura-status.active-nodespachado { background: var(--neutral); color: white; border-color: #475569; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .popup-table tr td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; }
        .popup-table tr td:first-child { color: #64748b; font-weight: 500; }
        .popup-table tr td:last-child { text-align: right; color: #1e293b; font-weight: 700; }
        
        .val-total { color: #0284c7 !important; font-size: 14px; font-weight: 900 !important; }
        .val-peso { color: #f59e0b !important; }

        .btn-unconfirm-all { 
            width: 100%; border: none; padding: 12px; font-size: 10px; font-weight: 800; 
            color: #ef4444; background: #fff; cursor: pointer; text-decoration: none; border-top: 1px solid #f1f5f9;
        }

        .nav-btn-footer { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--success); color: white; text-align: center; padding: 16px; 
            text-decoration: none; font-weight: 800; font-size: 13px;
        }

        .multi-selection-list { padding: 10px; display: flex; flex-direction: column; gap: 8px; max-height: 350px; overflow-y: auto; }
        .btn-select-client { 
            background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; 
            text-align: left; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-select-client:active { transform: scale(0.98); background: #f0f9ff; }
        .btn-select-client .client-name { font-weight: 900; font-size: 12px; color: #1e293b; text-transform: uppercase; }
        .btn-select-client .client-info { font-size: 10px; color: #64748b; margin-top: 2px; }

        .badge-multi {
            position: absolute; top: -8px; right: -12px; background: var(--danger); color: white; 
            font-size: 10px; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-weight: 900; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #panel-config { display: none; position: absolute; top: 10px; left: 10px; z-index: 1001; background: white; width: 280px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="window.activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">TRANSPORTADORA</span>
            <select id="filtroTransp" onchange="window.cambioTransportadora()">
                <option value="todos">CARGANDO...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">CHOFER</span>
            <select id="filtroChofer" onchange="window.actualizarMapa()">
                <option value="todos">TODOS LOS CHOFERES</option>
            </select>
        </div>
        <button class="btn-config" onclick="window.togglePanel()">‚öôÔ∏è CONFIGURACI√ìN</button>
        <div id="contador">Sincronizando...</div>
        <div id="db-status" onclick="window.handleSecretReset()">NUBE: CONECTANDO...</div>
    </div>

    <div id="panel-config">
        <div style="padding:15px; border-bottom:1px solid #eee; background:#0078d4; color:white; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center;">
            <strong>CONFIGURACI√ìN</strong> 
            <button onclick="window.togglePanel()" style="border:none;background:none;cursor:pointer;color:white;font-size:20px;">√ó</button>
        </div>
        <div style="padding:15px;">
            <span class="label-filter">Dise√±o del √çcono</span>
            <select id="selectIcono" onchange="window.cambiarTipoIcono(this.value)" style="margin-bottom:15px">
                <option value="pin">Pin Profesional</option>
                <option value="circle">Punto Circular</option>
            </select>
            <p style="font-size: 10px; color: #64748b; text-align: center; margin-top: 15px;">Versi√≥n Maestro 10.2 - LogiTrack Pro</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp, deleteApp, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE NUBE (AUTORIZADA RESTAURADA) ---
        const myFirebaseConfig = {
            apiKey: "AIzaSyCPPLoQOVvEsTV8p6SAynsLqfsvvmxZ8wA", // CLAVE MAESTRA MX Z8WA
            authDomain: "master-control-flota.firebaseapp.com",
            projectId: "master-control-flota",
            storageBucket: "master-control-flota.firebasestorage.app",
            messagingSenderId: "102366703423",
            appId: "1:102366703423:web:486d885f846cc2f82fad8a",
            measurementId: "G-T3NHDNL2E9"
        };

        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const appIdInterno = 'master-control-flota'; 
        const PROXIMITY_THRESHOLD = 0.0002;

        window.visitasMemoria = {};
        window.datosGlobales = [];
        window.clientesMapeados = {};
        window.tipoIconoGlobal = localStorage.getItem('tipoIconoV10') || 'pin';
        let db = null, auth = null, currentUser = null;
        let secretClicks = 0;

        // --- M√ìDULO DE SINCRONIZACI√ìN Y RESET ---
        window.handleSecretReset = () => {
            secretClicks++;
            if (secretClicks >= 5) {
                secretClicks = 0;
                window.borrarVisitasMasivo();
            }
            setTimeout(() => { secretClicks = 0; }, 3000);
        };

        window.borrarVisitasMasivo = async () => {
            const pin = prompt("PIN Maestro de Administraci√≥n:");
            if (pin === "1234") {
                if (confirm("Esta acci√≥n resetear√° TODOS los puntos para todos los usuarios. ¬øContinuar?")) {
                    const statusEl = document.getElementById("db-status");
                    statusEl.innerText = "RESET EN PROCESO...";
                    try {
                        if (db && currentUser) {
                            const snap = await getDocs(collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas'));
                            const promises = snap.docs.map(d => deleteDoc(d.ref));
                            await Promise.all(promises);
                            window.visitasMemoria = {};
                            window.actualizarMapa();
                            alert("Base de datos limpia. El mapa se ha reiniciado.");
                            statusEl.innerText = "NUBE: CONECTADO";
                        }
                    } catch (e) { alert("Error al resetear base de datos."); }
                }
            } else if (pin !== null) { alert("PIN Incorrecto."); }
        };

        window.actualizarFactura = async (bocaId, facturaId, nuevoEstado) => {
            let motivo = "";
            if (nuevoEstado !== "ENTREGADO") {
                motivo = prompt(`Ingrese motivo para la factura ${facturaId} (${nuevoEstado}):`);
                if (motivo === null) return;
                if (motivo.trim() === "") motivo = "Sin motivo especificado";
            }

            if (!window.visitasMemoria[bocaId]) window.visitasMemoria[bocaId] = { facturas: {} };
            if (!window.visitasMemoria[bocaId].facturas) window.visitasMemoria[bocaId].facturas = {};
            
            window.visitasMemoria[bocaId].facturas[facturaId] = { 
                status: nuevoEstado, 
                motivo: motivo, 
                ts: new Date().toISOString() 
            };
            
            window.actualizarMapa();
            setTimeout(() => window.abrirDetalleCliente(bocaId), 50);

            try {
                if (db && currentUser) {
                    await setDoc(doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(bocaId)), window.visitasMemoria[bocaId]);
                }
                const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(bocaId)}&factura=${encodeURIComponent(facturaId)}&status=${encodeURIComponent(nuevoEstado)}&motivo=${encodeURIComponent(motivo)}`;
                fetch(updateUrl, { mode: 'no-cors' });
            } catch(e) { console.error("Error al sincronizar:", e); }
        };

        window.resetPunto = async (id) => {
            if(!confirm("¬øBorrar estados de este punto?")) return;
            delete window.visitasMemoria[id];
            window.actualizarMapa();
            try {
                if (db && currentUser) await deleteDoc(doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(id)));
                fetch(`${SHEET_API}?mode=update&codBoca=${id}&status=PENDIENTE&motivo=RESET`, { mode: 'no-cors' }).finally(() => map.closePopup());
            } catch(e) {}
        };

        // --- MAPA Y FILTROS ---
        window.togglePanel = () => {
            const p = document.getElementById("panel-config");
            p.style.display = (p.style.display === "none" || p.style.display === "") ? "block" : "none";
        };

        window.cambiarTipoIcono = (val) => {
            window.tipoIconoGlobal = val;
            localStorage.setItem('tipoIconoV10', val);
            window.actualizarMapa();
        };

        window.activarGPS = () => { map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true}); };

        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);
        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', () => {
            const z = map.getZoom();
            document.body.classList.toggle('zoom-high', z >= 14);
            document.body.classList.toggle('zoom-low', z < 14);
        });

        function getVal(obj, keys) {
            if(!obj) return null;
            const objKeys = Object.keys(obj);
            for (let k of keys) {
                const searchKey = k.toLowerCase().replace(/[\s\._\/]/g, '');
                const foundKey = objKeys.find(ok => ok.toLowerCase().replace(/[\s\._\/]/g, '') === searchKey);
                if (foundKey) return obj[foundKey];
            }
            return null;
        }

        function normalizeString(val) { return val ? String(val).trim().toUpperCase() : ""; }

        function parseNum(val) {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[^0-9,.-]/g, "");
            if (str.includes(',') && !str.includes('.')) str = str.replace(',', '.'); 
            const res = parseFloat(str);
            return isNaN(res) ? 0 : res;
        }

        async function cargarDatosExcel() {
            try {
                const response = await fetch(SHEET_API);
                const rawData = await response.json();
                window.datosGlobales = rawData.map(d => ({
                    ...d,
                    _transp_limpia: normalizeString(getVal(d, ["Transportista", "Transp", "Suma de Transportista"])),
                    _chofer_limpio: normalizeString(getVal(d, ["Chofer", "Suma de Chofer"])),
                    _cod_boca: String(getVal(d, ["CodBoca", "C√≥d. Boca", "Suma de CodBoca"])).trim()
                }));
                const transpSet = new Set(window.datosGlobales.map(d => d._transp_limpia));
                llenarSelect("filtroTransp", Array.from(transpSet).sort(), "TODAS LAS TRANSPORTADORAS");
                window.cambioTransportadora(); 
            } catch (e) { console.error(e); }
        }

        function llenarSelect(id, lista, titulo) {
            const s = document.getElementById(id);
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => { if(i) s.innerHTML += `<option value="${i}">${i}</option>`; });
        }

        window.cambioTransportadora = () => {
            const valTransp = document.getElementById("filtroTransp").value;
            const choferesSet = new Set();
            window.datosGlobales.forEach(d => {
                if (valTransp === "todos" || d._transp_limpia === valTransp) choferesSet.add(d._chofer_limpio);
            });
            llenarSelect("filtroChofer", Array.from(choferesSet).sort(), "TODOS LOS CHOFERES");
            window.actualizarMapa();
        };

        window.actualizarMapa = () => {
            if (!layerGroup || !window.datosGlobales.length) return;
            layerGroup.clearLayers();
            const selTransp = document.getElementById("filtroTransp").value;
            const selChofer = document.getElementById("filtroChofer").value;
            
            const agrupaciones = [];
            window.clientesMapeados = {};

            window.datosGlobales.forEach(i => {
                if (selTransp !== "todos" && i._transp_limpia !== selTransp) return;
                if (selChofer !== "todos" && i._chofer_limpio !== selChofer) return;

                const lat = parseFloat(String(getVal(i, ["Latitud", "Lat", "Suma de Latitud"])).replace(',', '.'));
                const lon = parseFloat(String(getVal(i, ["Longitud", "Lon", "Suma de Longitud"])).replace(',', '.'));
                if (isNaN(lat)) return;

                const bocaId = i._cod_boca;
                if (!window.clientesMapeados[bocaId]) {
                    window.clientesMapeados[bocaId] = { 
                        lat, lon, id: bocaId, 
                        cliente: getVal(i, ["Cliente", "Boca", "Nombre Cliente", "Suma de Boca"]),
                        ciudad: getVal(i, ["Ciudad"]) || "S/C",
                        chofer: i._chofer_original || getVal(i, ["Chofer", "Suma de Chofer"]),
                        facturas: new Set(), pesoTotal: 0, importeTotal: 0 
                    };
                }
                const f = getVal(i, ["NumFactura", "Factura", "Suma de NumFactura"]);
                if(f) window.clientesMapeados[bocaId].facturas.add(String(f).trim());
                window.clientesMapeados[bocaId].pesoTotal += parseNum(getVal(i, ["Suma de Peso Total", "Peso"]));
                window.clientesMapeados[bocaId].importeTotal += parseNum(getVal(i, ["Suma de ImportePedidos/IVA", "Importe"]));

                let encontrado = false;
                for (let grupo of agrupaciones) {
                    const dist = Math.sqrt(Math.pow(grupo.lat - lat, 2) + Math.pow(grupo.lon - lon, 2));
                    if (dist < PROXIMITY_THRESHOLD) { grupo.idsBoca.add(bocaId); encontrado = true; break; }
                }
                if (!encontrado) agrupaciones.push({ lat, lon, idsBoca: new Set([bocaId]) });
            });

            agrupaciones.forEach(grupo => {
                const ids = Array.from(grupo.idsBoca);
                const esMulti = ids.length > 1;
                let procesado = false;
                ids.forEach(id => { if (window.visitasMemoria[id] && Object.keys(window.visitasMemoria[id].facturas || {}).length > 0) procesado = true; });

                const colorActual = procesado ? "#64748b" : "#0284c7";
                const iconHtml = `
                    <div style="position:relative;">
                        ${window.tipoIconoGlobal === "circle" 
                            ? `<div style="background:${colorActual}; width:18px; height:18px; border:2px solid white; border-radius:50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`
                            : `<svg width="34" height="34" viewBox="0 0 24 24" style="filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3))"><path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22S19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${colorActual}"/><circle cx="12" cy="9" r="3.5" fill="white"/></svg>`
                        }
                        ${esMulti ? `<div class="badge-multi">${ids.length}</div>` : ''}
                    </div>
                `;

                const marker = L.marker([grupo.lat, grupo.lon], { icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [34, 34], iconAnchor: [17, 34] }) }).addTo(layerGroup);
                if (!esMulti) marker.bindTooltip(`<div>${window.clientesMapeados[ids[0]].cliente}</div>`, { permanent: true, direction: 'right', className: 'label-boca', offset: [15, -15] });
                else marker.bindTooltip(`<div>${ids.length} CLIENTES CERCANOS</div>`, { permanent: true, direction: 'right', className: 'label-boca', offset: [15, -15] });

                marker.on('click', () => { if (!esMulti) window.abrirDetalleCliente(ids[0]); else window.abrirMenuSeleccion(ids, grupo.lat, grupo.lon); });
            });
            document.getElementById("contador").innerText = Object.keys(window.clientesMapeados).length + " Puntos de Entrega";
        };

        window.abrirMenuSeleccion = (ids, lat, lon) => {
            let html = `<div class="popup-container"><div class="popup-header"><h3>Varios clientes en esta zona</h3></div><div class="multi-selection-list">`;
            ids.forEach(id => {
                const c = window.clientesMapeados[id];
                const hecho = window.visitasMemoria[id] && Object.keys(window.visitasMemoria[id].facturas || {}).length > 0;
                html += `<div class="btn-select-client" onclick="window.abrirDetalleCliente('${id}')"><div><div class="client-name">${hecho ? '‚úÖ ' : 'üîµ '}${c.cliente}</div><div class="client-info">ID: ${id} | ${c.facturas.size} Facturas</div></div></div>`;
            });
            html += `</div></div>`;
            L.popup().setLatLng([lat, lon]).setContent(html).openOn(map);
        };

        window.abrirDetalleCliente = (id) => {
            const g = window.clientesMapeados[id];
            const facturasData = (window.visitasMemoria[id] || {}).facturas || {};
            let factRowsHtml = "";
            Array.from(g.facturas).forEach(fId => {
                const fD = facturasData[fId] || { status: "PENDIENTE", motivo: "" };
                factRowsHtml += `
                    <div class="factura-row">
                        <div class="factura-header-info">
                            <span style="font-size:11px;font-weight:800;color:#334155;">FACT: ${fId}</span>
                            <span class="factura-status-badge dot-${fD.status.toLowerCase().replace(" ", "")}">${fD.status}</span>
                        </div>
                        <div class="status-btn-group">
                            <button onclick="window.actualizarFactura('${id}', '${fId}', 'ENTREGADO')" class="btn-factura-status ${fD.status==='ENTREGADO'?'active-entregado':''}">Entr.</button>
                            <button onclick="window.actualizarFactura('${id}', '${fId}', 'PARCIAL')" class="btn-factura-status ${fD.status==='PARCIAL'?'active-parcial':''}">Parc.</button>
                            <button onclick="window.actualizarFactura('${id}', '${fId}', 'RECHAZADO')" class="btn-factura-status ${fD.status==='RECHAZADO'?'active-rechazado':''}">Rech.</button>
                            <button onclick="window.actualizarFactura('${id}', '${fId}', 'NO DESPACHADO')" class="btn-factura-status ${fD.status==='NO DESPACHADO'?'active-nodespachado':''}">N/D</button>
                        </div>
                        ${fD.motivo ? `<div style="font-size:9px; color:#64748b; font-style: italic;">Motivo: ${fD.motivo}</div>` : ''}
                    </div>`;
            });

            const html = `
                <div class="popup-container">
                    <div class="popup-header"><div style="display:flex; justify-content:space-between; align-items:center;"><h3>${g.cliente}</h3><button onclick="window.actualizarMapa()" style="border:none; background:none; color:var(--primary); cursor:pointer;">‚úñ</button></div><span style="font-size:10px;color:#64748b;">${g.ciudad} (ID: ${g.id})</span></div>
                    <div class="popup-section-title">Control por Factura</div>
                    <div class="facturas-list-container">${factRowsHtml}</div>
                    <table class="popup-table"><tr><td>Chofer</td><td>${g.chofer}</td></tr><tr><td>Peso Total</td><td class="val-peso">${g.pesoTotal.toFixed(2)} kg</td></tr><tr><td>Importe Total</td><td class="val-total">Gs. ${formatoDinero.format(g.importeTotal)}</td></tr></table>
                    ${Object.keys(facturasData).length > 0 ? `<button onclick="window.resetPunto('${id}')" class="btn-unconfirm-all">RESETEAR PUNTO</button>` : ''}
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${g.lat},${g.lon}" target="_blank" class="nav-btn-footer">IR CON GPS</a>
                </div>`;
            L.popup().setLatLng([g.lat, g.lon]).setContent(html).openOn(map);
        };

        // --- INICIALIZACI√ìN FIREBASE ---
        const initFirebase = async () => {
            const statusEl = document.getElementById("db-status");
            try {
                try { const old = getApp(); if(old) await deleteApp(old); } catch(e) {}
                const app = initializeApp(myFirebaseConfig);
                auth = getAuth(app); db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user; statusEl.innerText = "NUBE: CONECTADO"; statusEl.style.color = "#0284c7";
                        onSnapshot(collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas'), (snap) => {
                            snap.docChanges().forEach(change => {
                                if (change.type === "removed") delete window.visitasMemoria[change.doc.id];
                                else window.visitasMemoria[change.doc.id] = change.doc.data();
                            });
                            window.actualizarMapa();
                        }, (error) => {
                            console.error("Snapshot error:", error);
                            statusEl.innerText = "ERROR PERMISOS";
                        });
                        cargarDatosExcel();
                    } else { 
                        statusEl.innerText = "AUTENTICANDO...";
                        try { await signInAnonymously(auth); } catch(e) {
                            statusEl.innerText = "ERROR API KEY";
                            statusEl.style.color = "red";
                            cargarDatosExcel();
                        }
                    }
                });
            } catch(e) { statusEl.innerText = "ERROR INICIALIZACI√ìN"; cargarDatosExcel(); }
        };

        initFirebase();
    </script>
</body>
</html>
