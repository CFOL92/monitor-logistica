<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Master-Control-Flota | Sistema M√°ster</title>
    
    <!-- Leaflet para el Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0284c7;
            --success: #22c55e;
            --bg-glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f1f5f9; }
        #map { height: 100vh; width: 100%; background: #cbd5e1; }

        /* --- PANEL DE CONTROLES --- */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: var(--bg-glass); padding: 12px; border-radius: 12px;
            box-shadow: var(--shadow); width: 230px; 
            display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .label-filter { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; 
            width: 100%; font-size: 12px; background-color: #fff; color: #1e293b;
            cursor: pointer; transition: border-color 0.2s;
        }

        .btn-config { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-gps { background: #25D366; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #contador { font-size: 10px; text-align: center; color: #64748b; margin-top: 4px; font-weight: 600; }
        #db-status { font-size: 8px; text-align: center; color: #94a3b8; text-transform: uppercase; margin-top: 2px; font-weight: 800; letter-spacing: 0.4px; line-height: 1.2; }

        /* --- ETIQUETAS DEL MAPA --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #1a1a1a; font-size: 10px; font-weight: 700 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        
        .popup-container { background: white; }
        .popup-header { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .popup-header h3 { margin: 0; color: #333; font-size: 14px; font-weight: 800; text-transform: uppercase; line-height: 1.2; }
        .popup-header .subtitle { color: #888; font-size: 10px; font-weight: 500; display: block; margin-top: 2px; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; }
        .popup-table tr td { padding: 8px 15px; border-bottom: 1px solid #f8f8f8; }
        .popup-table tr td:first-child { background: #fafafa; color: #777; font-weight: 500; width: 45%; }
        .popup-table tr td:last-child { text-align: right; color: #333; font-weight: 600; }
        .popup-table .val-total { color: #0078d4 !important; font-weight: 800 !important; font-size: 13px; }

        .btn-visit-action { 
            width: 100%; border: none; padding: 12px; font-size: 11px; font-weight: 700; 
            text-transform: uppercase; cursor: pointer; transition: 0.2s;
            background: #f1f5f9; color: #475569; border-top: 1px solid #eee;
        }
        .btn-visit-action.active { background: #e2e8f0; color: #1e293b; text-decoration: line-through; }

        .nav-btn-footer { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: #0284c7; color: white; text-align: center; padding: 14px; 
            text-decoration: none; font-weight: 700; font-size: 14px;
        }

        /* --- PANEL DE CONFIGURACI√ìN --- */
        #panel-config { 
            display: none; position: absolute; top: 10px; left: 10px; z-index: 1001; 
            background: white; width: 280px; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); flex-direction: column; 
        }
        .panel-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #0078d4; color: white; border-radius: 12px 12px 0 0; }
        .panel-body { padding: 15px; max-height: 70vh; overflow-y: auto; }

        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="window.activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">TRANSPORTADORA</span>
            <select id="filtroTransp" onchange="window.cambioTransportadora()">
                <option value="todos">CARGANDO...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">CHOFER</span>
            <select id="filtroChofer" onchange="window.actualizarMapa()">
                <option value="todos">TODOS LOS CHOFERES</option>
            </select>
        </div>
        <button class="btn-config" onclick="window.togglePanel()">‚öôÔ∏è CONFIGURACI√ìN</button>
        <div id="contador">Sincronizando...</div>
        <div id="db-status">NUBE: CONECTANDO...</div>
    </div>

    <div id="panel-config">
        <div class="panel-header"><strong>CONFIGURACIONES</strong> <button onclick="window.togglePanel()" style="border:none;background:none;cursor:pointer;color:white;font-size:20px;">√ó</button></div>
        <div class="panel-body">
            <span class="label-filter">Dise√±o del √çcono</span>
            <select id="selectIcono" onchange="window.cambiarTipoIcono(this.value)" style="margin-bottom:15px">
                <option value="pin">Pin Profesional</option>
                <option value="circle">Punto Circular</option>
            </select>
            <button onclick="window.borrarVisitas()" style="width:100%; margin-top:20px; padding:12px; font-size:10px; background:#fef2f2; color:#b91c1c; border:1px solid #fee2e2; border-radius:6px; cursor:pointer; font-weight:800;">REINICIAR VISITAS (ADMIN)</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp, deleteApp, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACI√ìN MAESTRA ---
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const COLOR_PREDETERMINADO = "#0ea5e9"; 
        const COLOR_VISITADO = "#64748b"; 
        const appIdInterno = 'master-control-flota'; 

        const myFirebaseConfig = {
            apiKey: "AIzaSyCPPLoQOVvEsTV8p6SAynsLqfsvvmxZ8wA",
            authDomain: "master-control-flota.firebaseapp.com",
            projectId: "master-control-flota",
            storageBucket: "master-control-flota.firebasestorage.app",
            messagingSenderId: "102366703423",
            appId: "1:102366703423:web:486d885f846cc2f82fad8a",
            measurementId: "G-T3NHDNL2E9"
        };

        window.visitasMemoria = {};
        window.datosGlobales = [];
        window.tipoIconoGlobal = localStorage.getItem('tipoIconoV10') || 'pin';
        let db = null, auth = null, currentUser = null;

        // --- INICIALIZACI√ìN DEL MAPA ---
        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);
        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', () => {
            const z = map.getZoom();
            document.body.classList.toggle('zoom-high', z >= 14);
            document.body.classList.toggle('zoom-low', z < 14);
        });

        window.togglePanel = () => {
            const p = document.getElementById("panel-config");
            if(p) p.style.display = (p.style.display === "none" || p.style.display === "") ? "flex" : "none";
        };

        window.cambiarTipoIcono = (val) => {
            window.tipoIconoGlobal = val;
            localStorage.setItem('tipoIconoV10', val);
            window.actualizarMapa();
        };

        window.activarGPS = () => {
            const contadorEl = document.getElementById("contador");
            if(contadorEl) contadorEl.innerText = "Ubicando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        };

        map.on('locationfound', (e) => {
            L.circle(e.latlng, e.accuracy/2, {color: '#22c55e', weight:1, fillOpacity: 0.1}).addTo(map);
            L.marker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
        });

        // --- MOTOR DE PROCESAMIENTO DE DATOS ---
        function getVal(obj, keys) {
            if(!obj) return null;
            const objKeys = Object.keys(obj);
            for (let k of keys) {
                const searchKey = k.toLowerCase().replace(/[\s\._\/]/g, '');
                const foundKey = objKeys.find(ok => ok.toLowerCase().replace(/[\s\._\/]/g, '') === searchKey);
                if (foundKey && obj[foundKey] !== undefined && obj[foundKey] !== null && obj[foundKey] !== "") {
                    return obj[foundKey];
                }
            }
            return null;
        }

        // Funci√≥n de normalizaci√≥n estricta para que los filtros no fallen por espacios o may√∫sculas
        function normalizeString(val) {
            if (!val) return "";
            return String(val).trim().toUpperCase();
        }

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[^0-9,.-]/g, "");
            if (str.includes(',') && !str.includes('.')) {
                const parts = str.split(',');
                if (parts.length > 1 && parts[parts.length-1].length === 3) str = str.replace(/,/g, ""); 
                else if (parts.length === 2) str = str.replace(',', '.'); 
            } else if (str.includes(',') && str.includes('.')) {
                if (str.lastIndexOf(',') > str.lastIndexOf('.')) str = str.replace(/\./g, "").replace(',', '.');
                else str = str.replace(/,/g, ""); 
            } else if (str.includes('.')) {
                const parts = str.split('.');
                if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3 && parseFloat(str) < 1000)) str = str.replace(/\./g, "");
            }
            const res = parseFloat(str);
            return isNaN(res) ? 0 : res;
        }

        async function cargarDatosExcel() {
            try {
                const response = await fetch(SHEET_API);
                const data = await response.json();
                window.datosGlobales = data;
                
                // Extracci√≥n inicial de transportadoras √∫nicas
                const transportistasSet = new Set();
                data.forEach(d => {
                    const v = getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]);
                    if (v) transportistasSet.add(normalizeString(v));
                });
                
                const transportistas = Array.from(transportistasSet).sort();
                llenarSelect("filtroTransp", transportistas, "TODAS LAS TRANSPORTADORAS");
                
                // Actualizar choferes seg√∫n la selecci√≥n inicial
                window.cambioTransportadora(); 
                window.actualizarMapa(true);
            } catch (e) { console.error("Error Excel:", e); }
        }

        function llenarSelect(id, lista, titulo) {
            const s = document.getElementById(id);
            if(!s) return;
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => {
                const op = document.createElement("option"); 
                op.value = i; 
                op.innerText = i; 
                s.appendChild(op);
            });
        }

        // --- L√ìGICA DE FILTROS DIN√ÅMICOS (SOLUCI√ìN DEFINITIVA) ---
        window.cambioTransportadora = () => {
            const rawTransp = document.getElementById("filtroTransp").value;
            const selTransp = normalizeString(rawTransp);
            const choferSelect = document.getElementById("filtroChofer");
            
            // 1. Filtrar choferes relacionados
            const choferesSet = new Set();
            window.datosGlobales.forEach(d => {
                const transpData = normalizeString(getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]));
                const choferData = getVal(d, ["Chofer", "Suma de Chofer"]);
                
                if (selTransp === "TODOS" || transpData === selTransp) {
                    if (choferData) choferesSet.add(normalizeString(choferData));
                }
            });
            
            // 2. Poblar el select de choferes
            const choferesFiltrados = Array.from(choferesSet).sort();
            llenarSelect("filtroChofer", choferesFiltrados, "TODOS LOS CHOFERES");
            choferSelect.value = "todos"; 
            
            // 3. Refrescar mapa
            window.actualizarMapa();
        };

        window.actualizarMapa = (fit = false) => {
            if (!layerGroup || !window.datosGlobales.length) return;
            layerGroup.clearLayers();
            
            // Obtenemos valores de los filtros (sin normalizar para checkear 'todos')
            const rawTransp = document.getElementById("filtroTransp").value;
            const rawChofer = document.getElementById("filtroChofer").value;
            
            const selTransp = normalizeString(rawTransp);
            const selChofer = normalizeString(rawChofer);
            
            const bounds = [];
            const grupos = {};

            window.datosGlobales.forEach(i => {
                const transpRow = normalizeString(getVal(i, ["Transp", "Transportadora", "Suma de Transportista"]));
                const choferRow = normalizeString(getVal(i, ["Chofer", "Suma de Chofer"]));
                
                // --- L√ìGICA DE FILTRADO ROBUSTA ---
                const cumpleTransp = (rawTransp === "todos") || (transpRow === selTransp);
                const cumpleChofer = (rawChofer === "todos") || (choferRow === selChofer);

                if (!cumpleTransp || !cumpleChofer) return;

                const latRaw = getVal(i, ["Latitud", "Lat", "Suma de Latitud"]);
                const lonRaw = getVal(i, ["Longitud", "Lon", "Suma de Longitud"]);
                
                if (!latRaw || !lonRaw) return;
                
                const lat = parseFloat(String(latRaw).replace(',', '.').trim());
                const lon = parseFloat(String(lonRaw).replace(',', '.').trim());
                if (isNaN(lat) || isNaN(lon)) return;

                const idBocaRaw = getVal(i, ["CodBoca", "C√≥d. Boca", "Suma de CodBoca"]);
                const idBoca = idBocaRaw ? String(idBocaRaw).trim() : `pos_${lat}_${lon}`;
                
                if (!grupos[idBoca]) {
                    grupos[idBoca] = { 
                        lat, lon, id: idBoca, 
                        cliente: getVal(i, ["Cliente", "Boca", "Nombre Cliente", "Suma de Boca", "Suma de Cliente"]) || "SIN NOMBRE",
                        ciudad: getVal(i, ["Ciudad"]) || "S/C",
                        choferDisplay: getVal(i, ["Chofer", "Suma de Chofer"]) || "N/A",
                        total: 0, count: 0, facturas: new Set()
                    };
                }
                const importe = getVal(i, ["Suma de ImportePedidos/IVA", "Importe", "ImporteTotal"]);
                grupos[idBoca].total += parseNum(importe);
                grupos[idBoca].count++;
                
                const f = getVal(i, ["NumFactura", "Suma de NumFactura"]);
                if(f) grupos[idBoca].facturas.add(f);
                
                bounds.push([lat, lon]);
            });

            Object.values(grupos).forEach(g => {
                const esVisitado = (!!window.visitasMemoria[g.id]);
                const colorActual = esVisitado ? COLOR_VISITADO : COLOR_PREDETERMINADO;
                
                let marker;
                if (window.tipoIconoGlobal === "circle") {
                    marker = L.circleMarker([g.lat, g.lon], { radius: 8, fillColor: colorActual, color: "#fff", weight: 2, opacity: 1, fillOpacity: 1 });
                } else {
                    const pinIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4))">
                            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${colorActual}"/>
                            <circle cx="12" cy="9" r="3.5" fill="white"/>
                        </svg>`,
                        iconSize: [34, 34], iconAnchor: [17, 34]
                    });
                    marker = L.marker([g.lat, g.lon], { icon: pinIcon });
                }

                marker.bindTooltip((esVisitado ? "‚úÖ " : "") + g.cliente, { 
                    permanent: true, direction: 'right', className: 'label-boca', offset: [15, -15] 
                });

                const popupHtml = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h3>${g.cliente}</h3>
                            <span class="subtitle">${g.ciudad} (ID: ${g.id})</span>
                        </div>
                        <table class="popup-table">
                            <tr><td>Chofer</td><td>${g.choferDisplay}</td></tr>
                            <tr><td>Facturas</td><td>${Array.from(g.facturas).length}</td></tr>
                            <tr><td>Total Gs.</td><td class="val-total">${formatoDinero.format(g.total)}</td></tr>
                        </table>
                        <button id="btn-${g.id}" onclick="window.toggleVisitado('${g.id}')" class="btn-visit-action ${esVisitado ? 'active' : ''}">
                            ${esVisitado ? 'REMOVER VISITA' : 'CONFIRMAR VISITA'}
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${g.lat},${g.lon}" target="_blank" class="nav-btn-footer">IR CON GPS</a>
                    </div>
                `;
                marker.bindPopup(popupHtml).addTo(layerGroup);
            });

            if (fit && bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            document.getElementById("contador").innerText = Object.keys(grupos).length + " Puntos Cargados";
        };

        // --- FIREBASE (PROTOCOLO ESTABLE) ---
        const initFirebase = async () => {
            const statusEl = document.getElementById("db-status");
            try {
                try { const oldApp = getApp(); await deleteApp(oldApp); } catch(e) {}
                const appInstance = initializeApp(myFirebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        statusEl.innerText = "NUBE: CONECTADO";
                        statusEl.style.color = "#0284c7";
                        startRealtimeSync();
                        cargarDatosExcel();
                    } else {
                        statusEl.innerText = "NUBE: AUTENTICANDO...";
                        try {
                            await signOut(auth);
                            await signInAnonymously(auth);
                        } catch(err) {
                            statusEl.innerText = "NUBE: ERROR AUTH";
                            statusEl.style.color = "#ef4444";
                            cargarDatosExcel();
                        }
                    }
                });
            } catch(e) { statusEl.innerText = "NUBE: ERROR INICIO"; cargarDatosExcel(); }
        };

        function startRealtimeSync() {
            if (!db || !currentUser) return;
            const ref = collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas');
            onSnapshot(ref, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    window.visitasMemoria[change.doc.id] = change.doc.data().visitado;
                });
                window.actualizarMapa();
            }, (err) => {
                const statusEl = document.getElementById("db-status");
                if(statusEl) statusEl.innerText = "NUBE: ERROR REGLAS";
            });
        }

        window.toggleVisitado = async (id) => {
            const currentStatus = (window.visitasMemoria[id] === true);
            const newStatus = !currentStatus;
            const btn = document.getElementById(`btn-${id}`);
            if(btn) { btn.disabled = true; btn.innerText = "SINCRONIZANDO..."; }

            window.visitasMemoria[id] = newStatus;
            window.actualizarMapa();
            
            try {
                if (currentUser && db) {
                    const visitDoc = doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(id));
                    await setDoc(visitDoc, { visitado: newStatus, timestamp: new Date() });
                }
                const labelStatus = newStatus ? 'Visitado' : 'Pendiente';
                const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(id)}&status=${encodeURIComponent(labelStatus)}`;
                fetch(updateUrl, { mode: 'no-cors' }).finally(() => {
                    if(btn) btn.disabled = false;
                    map.closePopup();
                });
            } catch(e) { if(btn) btn.disabled = false; }
        };

        window.borrarVisitas = async () => {
            const pin = prompt("PIN Administrador:");
            if (pin === "1234" && confirm("¬øBorrar todas las visitas registradas?")) {
                if (db && currentUser) {
                    const snap = await getDocs(collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas'));
                    const delArr = [];
                    snap.forEach((d) => delArr.push(deleteDoc(d.ref)));
                    await Promise.all(delArr);
                    window.visitasMemoria = {};
                    window.actualizarMapa();
                    alert("Visitas reiniciadas con √©xito.");
                }
            }
        };

        initFirebase();
    </script>
</body>
</html>
