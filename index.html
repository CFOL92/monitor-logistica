<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Master-Control-Flota | Sistema M√°ster</title>
    
    <!-- Leaflet para el Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0284c7;
            --success: #22c55e;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; background: #f1f5f9; }
        #map { height: 100vh; width: 100%; background: #cbd5e1; }

        /* --- CONTROLES SUPERIORES --- */
        .controls {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: var(--bg-glass); padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow); width: 240px; 
            display: flex; flex-direction: column; gap: 12px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .label-filter { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 2px; display: block; }
        
        select { 
            padding: 10px; border: 1px solid #cbd5e1; border-radius: 10px; 
            width: 100%; font-size: 13px; background-color: #fff; color: #1e293b;
            cursor: pointer; transition: all 0.2s; outline: none;
        }

        .btn-gps { 
            background: var(--success); color: white; border: none; padding: 12px; 
            border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        #contador { font-size: 11px; text-align: center; color: #475569; font-weight: 600; margin-top: 5px; }
        #db-status { font-size: 9px; text-align: center; color: #94a3b8; text-transform: uppercase; margin-top: 2px; font-weight: 800; letter-spacing: 0.5px; line-height: 1.2; }

        /* --- ETIQUETAS DIN√ÅMICAS --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #0f172a; font-size: 11px; font-weight: 700 !important; 
            white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        /* Zoom din√°mico: mostrar etiquetas solo cuando estamos cerca */
        .zoom-low .label-boca { opacity: 0; visibility: hidden; }
        .zoom-high .label-boca { opacity: 1; visibility: visible; }

        /* --- POPUPS --- */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        
        .popup-container { background: white; }
        .popup-header { padding: 15px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        .popup-header h3 { margin: 0; color: #1e293b; font-size: 15px; font-weight: 800; text-transform: uppercase; line-height: 1.2; }
        .popup-header .subtitle { color: #94a3b8; font-size: 11px; font-weight: 500; display: block; margin-top: 4px; }

        .popup-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .popup-table tr td { padding: 10px 15px; border-bottom: 1px solid #f8fafc; }
        .popup-table tr td:first-child { background: #f8fafc; color: #64748b; font-weight: 600; width: 40%; }
        .popup-table tr td:last-child { text-align: right; color: #1e293b; font-weight: 700; }
        .popup-table .val-total { color: var(--primary) !important; font-size: 15px; }

        .btn-visit-action { 
            width: 100%; border: none; padding: 15px; font-size: 12px; font-weight: 800; 
            text-transform: uppercase; cursor: pointer; transition: 0.2s;
            background: #f1f5f9; color: #475569; border-top: 1px solid #e2e8f0;
        }
        .btn-visit-action.active { background: #e2e8f0; color: #94a3b8; text-decoration: line-through; }

        .nav-btn-footer { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--primary); color: white; text-align: center; padding: 16px; 
            text-decoration: none; font-weight: 800; font-size: 14px;
        }

        .custom-div-icon { display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
    </style>
</head>
<body class="zoom-low">

    <div class="controls">
        <button class="btn-gps" onclick="window.activarGPS()">üìç MI UBICACI√ìN</button>
        <div>
            <span class="label-filter">Transportadora</span>
            <select id="filtroTransp" onchange="window.cambioTransportadora()">
                <option value="todos">Cargando...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">Chofer</span>
            <select id="filtroChofer" onchange="window.actualizarMapa()">
                <option value="todos">...</option>
            </select>
        </div>
        <div id="contador">Sincronizando Excel...</div>
        <div id="db-status">NUBE: CONECTANDO...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACI√ìN MAESTRA (VERIFICADA) ---
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 
        const COLOR_PREDETERMINADO = "#0ea5e9"; 
        const COLOR_VISITADO = "#64748b"; 
        const appIdInterno = 'master-control-flota'; 

        const myFirebaseConfig = {
            apiKey: "AIzaSyAcNUSS0zgcCtqpyJf5E76WWSGuXPbqa88",
            authDomain: "master-control-flota.firebaseapp.com",
            projectId: "master-control-flota",
            storageBucket: "master-control-flota.firebasestorage.app",
            messagingSenderId: "102366703423",
            appId: "1:102366703423:web:486d885f846cc2f82fad8a",
            measurementId: "G-T3NHDNL2E9"
        };

        window.visitasMemoria = {};
        window.datosGlobales = [];
        let db = null, auth = null, currentUser = null;

        // --- INICIALIZAR MAPA ---
        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);
        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', () => {
            const z = map.getZoom();
            document.body.classList.toggle('zoom-high', z >= 14);
            document.body.classList.toggle('zoom-low', z < 14);
        });

        window.activarGPS = () => {
            const contadorEl = document.getElementById("contador");
            if(contadorEl) contadorEl.innerText = "Ubicando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        };

        map.on('locationfound', (e) => {
            L.circle(e.latlng, e.accuracy/2, {color: '#22c55e', weight:1, fillOpacity: 0.1}).addTo(map);
            L.marker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
        });

        // --- MOTOR DE DATOS ---
        function getVal(obj, keys) {
            if(!obj) return null;
            const objKeys = Object.keys(obj);
            for (let k of keys) {
                const searchKey = k.toLowerCase().replace(/[\s\._\/]/g, '');
                const found = objKeys.find(ok => ok.toLowerCase().replace(/[\s\._\/]/g, '') === searchKey);
                if (found && obj[found] !== undefined && obj[found] !== null && obj[found] !== "") return obj[found];
            }
            return null;
        }

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[^0-9,.-]/g, "");
            
            // L√≥gica para montos millonarios (1,231,126)
            if (str.includes(',') && !str.includes('.')) {
                const parts = str.split(',');
                if (parts.length > 1 && parts[parts.length-1].length === 3) str = str.replace(/,/g, ""); 
                else if (parts.length === 2) str = str.replace(',', '.'); 
            } else if (str.includes(',') && str.includes('.')) {
                if (str.lastIndexOf(',') > str.lastIndexOf('.')) str = str.replace(/\./g, "").replace(',', '.');
                else str = str.replace(/,/g, ""); 
            } else if (str.includes('.')) {
                const parts = str.split('.');
                if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3 && parseFloat(str) < 1000)) str = str.replace(/\./g, "");
            }
            const res = parseFloat(str);
            return isNaN(res) ? 0 : res;
        }

        async function cargarDatosExcel() {
            try {
                const response = await fetch(SHEET_API);
                const data = await response.json();
                window.datosGlobales = data;
                
                const transportistas = [...new Set(data.map(d => getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T"))].filter(Boolean).sort();
                llenarSelect("filtroTransp", transportistas, "TODAS LAS TRANSPORTADORAS");
                
                window.actualizarMapa(true);
            } catch (e) { 
                console.error("Error Excel:", e); 
            }
        }

        function llenarSelect(id, lista, titulo) {
            const s = document.getElementById(id);
            if(!s) return;
            s.innerHTML = `<option value="todos">${titulo}</option>`;
            lista.forEach(i => {
                const op = document.createElement("option"); op.value = i; op.innerText = i; s.appendChild(op);
            });
        }

        window.cambioTransportadora = () => {
            const t = document.getElementById("filtroTransp").value;
            const filtrados = (t === "todos") ? window.datosGlobales : window.datosGlobales.filter(d => (getVal(d, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T") === t);
            const choferes = [...new Set(filtrados.map(d => getVal(d, ["Chofer", "Suma de Chofer"]) || "S/C"))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS LOS CHOFERES");
            window.actualizarMapa();
        };

        window.actualizarMapa = (fit = false) => {
            if (!layerGroup || !window.datosGlobales.length) return;
            layerGroup.clearLayers();
            const selTransp = document.getElementById("filtroTransp").value;
            const selChofer = document.getElementById("filtroChofer").value;
            const bounds = [];
            const grupos = {};

            window.datosGlobales.forEach(i => {
                const chofer = getVal(i, ["Chofer", "Suma de Chofer"]) || "S/C";
                const transp = getVal(i, ["Transp", "Transportadora", "Suma de Transportista"]) || "S/T";
                if (selTransp !== "todos" && transp !== selTransp) return;
                if (selChofer !== "todos" && chofer !== selChofer) return;

                const lat = parseFloat(String(getVal(i, ["Latitud", "Lat", "Suma de Latitud"]) || "").replace(',', '.').trim());
                const lon = parseFloat(String(getVal(i, ["Longitud", "Lon", "Suma de Longitud"]) || "").replace(',', '.').trim());
                if (isNaN(lat) || isNaN(lon)) return;

                const idBoca = getVal(i, ["CodBoca", "C√≥d. Boca", "Suma de CodBoca"]);
                const key = idBoca || `${lat}_${lon}`;
                
                if (!grupos[key]) {
                    grupos[key] = { 
                        lat, lon, id: key, 
                        cliente: getVal(i, ["Cliente", "Boca", "Nombre Cliente", "Suma de Boca", "Suma de Cliente"]) || "SIN NOMBRE",
                        ciudad: getVal(i, ["Ciudad"]) || "S/C",
                        chofer: chofer,
                        total: 0, count: 0, facturas: []
                    };
                }
                const importe = getVal(i, ["Suma de ImportePedidos/IVA", "Importe", "ImporteTotal", "ImportePedidos"]);
                grupos[key].total += parseNum(importe);
                grupos[key].count++;
                grupos[key].facturas.push(getVal(i, ["NumFactura", "Suma de NumFactura"]));
                bounds.push([lat, lon]);
            });

            Object.values(grupos).forEach(g => {
                const esVisitado = (!!window.visitasMemoria[g.id]);
                const colorActual = esVisitado ? COLOR_VISITADO : COLOR_PREDETERMINADO;
                
                const pinIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4))">
                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill="${colorActual}"/>
                        <circle cx="12" cy="9" r="3.5" fill="white"/>
                    </svg>`,
                    iconSize: [34, 34], iconAnchor: [17, 34]
                });

                const marker = L.marker([g.lat, g.lon], { icon: pinIcon });
                marker.bindTooltip((esVisitado ? "‚úÖ " : "") + g.cliente, { 
                    permanent: true, direction: 'right', className: 'label-boca', offset: [15, -15] 
                });

                const popupHtml = `
                    <div class="popup-container">
                        <div class="popup-header">
                            <h3>${g.cliente}</h3>
                            <span class="subtitle">${g.ciudad} (ID: ${g.id})</span>
                        </div>
                        <table class="popup-table">
                            <tr><td>Chofer</td><td>${g.chofer}</td></tr>
                            <tr><td>Entregas</td><td>${g.count}</td></tr>
                            <tr><td>Total Gs.</td><td class="val-total">${formatoDinero.format(g.total)}</td></tr>
                        </table>
                        <button id="btn-${g.id}" onclick="window.toggleVisitado('${g.id}')" class="btn-visit-action ${esVisitado ? 'active' : ''}">
                            ${esVisitado ? 'REMOVER VISITA' : 'CONFIRMAR VISITA'}
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${g.lat},${g.lon}" target="_blank" class="nav-btn-footer">IR AHORA (GPS)</a>
                    </div>
                `;
                marker.bindPopup(popupHtml).addTo(layerGroup);
            });

            if (fit && bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            document.getElementById("contador").innerText = Object.keys(grupos).length + " Puntos Cargados";
        };

        // --- FIREBASE (PROTOCOLO SEGURO) ---
        const initFirebase = async () => {
            const statusEl = document.getElementById("db-status");
            try {
                const appInstance = initializeApp(myFirebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        statusEl.innerText = "NUBE: CONECTADO";
                        statusEl.style.color = "#0284c7";
                        startRealtimeSync();
                        cargarDatosExcel();
                    } else {
                        statusEl.innerText = "NUBE: AUTENTICANDO...";
                        try {
                            await signOut(auth); 
                            await signInAnonymously(auth);
                        } catch(err) {
                            console.error("Auth Fail:", err.code);
                            statusEl.innerText = "NUBE: " + err.code.toUpperCase();
                            statusEl.style.color = "#ef4444";
                            cargarDatosExcel();
                        }
                    }
                });
            } catch(e) { 
                console.error("Init Fail:", e);
                statusEl.innerText = "NUBE: ERROR DE INICIO";
                statusEl.style.color = "#ef4444";
                cargarDatosExcel();
            }
        };

        function startRealtimeSync() {
            if (!db || !currentUser) return;
            const ref = collection(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas');
            onSnapshot(ref, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    window.visitasMemoria[change.doc.id] = change.doc.data().visitado;
                });
                window.actualizarMapa();
            }, (err) => {
                console.error("Sync Fail:", err);
                const statusEl = document.getElementById("db-status");
                if(statusEl) statusEl.innerText = "NUBE: ERROR DE ACCESO";
            });
        }

        window.toggleVisitado = async (id) => {
            const currentStatus = (window.visitasMemoria[id] === true);
            const newStatus = !currentStatus;
            const btn = document.getElementById(`btn-${id}`);
            if(btn) { btn.disabled = true; btn.innerText = "SINCRONIZANDO..."; }
            window.visitasMemoria[id] = newStatus;
            window.actualizarMapa();
            try {
                if (currentUser && db) {
                    const visitDoc = doc(db, 'artifacts', appIdInterno, 'public', 'data', 'visitas', String(id));
                    await setDoc(visitDoc, { visitado: newStatus, timestamp: new Date() });
                }
                const labelStatus = newStatus ? 'Visitado' : 'Pendiente';
                const updateUrl = `${SHEET_API}?mode=update&codBoca=${encodeURIComponent(id)}&status=${encodeURIComponent(labelStatus)}`;
                fetch(updateUrl, { mode: 'no-cors' }).finally(() => {
                    if(btn) btn.disabled = false;
                    map.closePopup();
                });
            } catch(e) { if(btn) btn.disabled = false; }
        };

        initFirebase();
    </script>
</body>
</html>
