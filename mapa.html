<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Log√≠stica GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; background: #f4f4f4; }
        #map { height: 100vh; width: 100%; }

        /* --- CONTROLES --- */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 180px; 
            display: flex; flex-direction: column; gap: 6px;
        }
        
        .label-filter { font-size: 10px; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        
        select { 
            padding: 4px; border: 1px solid #ddd; border-radius: 4px; 
            width: 100%; font-size: 11px; background-color: #fff; color: #333;
            -webkit-appearance: none; 
        }
        select:focus { outline: none; border-color: #0078d4; }

        .btn-config { 
            background: #0078d4; color: white; border: none; padding: 8px; 
            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; margin-top: 2px;
        }
        
        /* Bot√≥n GPS Mejorado */
        .btn-gps {
            background: #25D366; color: white; border: none; padding: 8px; 
            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; margin-top: 2px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        #contador { font-size: 9px; text-align: center; color: #888; margin-top: 2px; }

        /* --- ETIQUETAS --- */
        .label-boca {
            background: transparent; border: none; box-shadow: none;
            color: #444; font-size: 11px; font-weight: normal; white-space: nowrap;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transition: opacity 0.2s; margin-left: 8px;
        }
        .zoom-out .label-boca { opacity: 0; visibility: hidden; }
        .zoom-in .label-boca { opacity: 1; visibility: visible; }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper { border-radius: 6px; padding: 0; box-shadow: 0 3px 14px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        
        .popup-header { background: #f8f9fa; padding: 10px 12px; border-bottom: 1px solid #eaeaea; border-radius: 6px 6px 0 0; }
        .popup-header h3 { margin: 0; color: #222; font-size: 14px; font-weight: 700; line-height: 1.3; }
        .popup-header small { display: block; margin-top: 2px; color: #777; font-size: 10px; }

        .popup-body { padding: 0; }

        .info-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .info-table tr { border-bottom: 1px solid #f0f0f0; }
        .info-table tr:last-child { border-bottom: none; }
        .info-table td { padding: 6px 12px; vertical-align: top; }
        .info-table td.label { color: #666; width: 35%; font-weight: 500; background-color: #fafafa; }
        .info-table td.value { color: #333; text-align: right; font-weight: 400; }
        .highlight-money { color: #0078d4; font-weight: 700; font-size: 13px; }
        
        .badge-container { padding: 8px 12px; display: flex; gap: 5px; flex-wrap: wrap; background: #fff; }
        .badge { padding: 2px 6px; border-radius: 3px; color: white; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; }

        .nav-btn { display: block; background: #25D366; color: white; text-align: center; padding: 10px; text-decoration: none; font-weight: 600; font-size: 13px; border-radius: 0 0 6px 6px; }

        #panel-colores { display: none; position: absolute; top: 10px; left: 10px; z-index: 1001; background: white; width: 250px; max-height: 80vh; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); flex-direction: column; }
        .panel-header { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; background: #f4f4f4; border-radius: 8px 8px 0 0; }
        .panel-body { padding: 10px; overflow-y: auto; }
        .chofer-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 12px; }
    </style>
</head>
<body class="zoom-out">

    <div class="controls">
        <button class="btn-gps" onclick="activarGPS()">üìç Mi Ubicaci√≥n</button>

        <div>
            <span class="label-filter">Transportadora</span>
            <select id="filtroTransp" onchange="cambioTransportadora()">
                <option value="todos">Cargando...</option>
            </select>
        </div>
        <div>
            <span class="label-filter">Chofer</span>
            <select id="filtroChofer" onchange="actualizarMapa()">
                <option value="todos">...</option>
            </select>
        </div>
        
        <button class="btn-config" onclick="togglePanel()">üé® Colores</button>
        <div id="contador">Iniciando...</div>
    </div>

    <div id="panel-colores">
        <div class="panel-header"><strong>Colores</strong> <button onclick="togglePanel()" style="border:none;background:none;cursor:pointer;">‚úñ</button></div>
        <div class="panel-body" id="lista-colores"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SHEET_API = 'https://script.google.com/macros/s/AKfycbw4MMDN7k9m9V34L62FDWryaed0iPQZhWqVIC37G7SXNjS8m-vxvthHmiuX70len8-9/exec'; 

        var map = L.map('map', {zoomControl: false}).setView([-25.30, -57.60], 11);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var layerGroup = L.layerGroup().addTo(map);

        var datosGlobales = [];
        var coloresMemoria = {};
        var userMarker = null; 
        var userCircle = null;

        // Recuperar colores (Modo Seguro para iPhone)
        try {
            var guardado = localStorage.getItem('coloresLogisticaV9');
            if (guardado) coloresMemoria = JSON.parse(guardado);
        } catch (e) { console.log("Modo seguro activado"); }

        const formatoDinero = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

        map.on('zoomend', function() {
            var z = map.getZoom();
            if (z >= 15) { document.body.classList.replace('zoom-out', 'zoom-in'); } 
            else { document.body.classList.replace('zoom-in', 'zoom-out'); }
        });

        // === GPS ROBUSTO (CON REINTENTO) ===
        function activarGPS() {
            document.getElementById("contador").innerText = "Buscando sat√©lites...";
            
            // Intento 1: Alta Precisi√≥n (GPS Puro)
            map.locate({
                setView: true, 
                maxZoom: 16, 
                enableHighAccuracy: true,
                timeout: 5000 // Esperar m√°x 5 segundos
            });
        }

        map.on('locationfound', function(e) {
            var radius = e.accuracy / 2;
            if (userMarker) { map.removeLayer(userMarker); map.removeLayer(userCircle); }

            userMarker = L.marker(e.latlng).addTo(map)
                .bindPopup("<b>¬°Est√°s aqu√≠!</b><br>Precisi√≥n: " + Math.round(radius) + "m").openPopup();
            userCircle = L.circle(e.latlng, radius, {color: '#0078d4', fillColor: '#0078d4', fillOpacity: 0.1}).addTo(map);
            
            document.getElementById("contador").innerText = "Ubicaci√≥n encontrada";
        });

        // Manejo de Errores Inteligente
        map.on('locationerror', function(e) {
            console.warn("Fallo GPS Alta Precisi√≥n: " + e.message);
            
            // Si fall√≥ por tiempo (timeout) o se√±al, reintentamos con Baja Precisi√≥n (WiFi)
            if (e.code === 3 || e.message.includes("timeout")) {
                document.getElementById("contador").innerText = "Reintentando por WiFi...";
                map.locate({
                    setView: true, 
                    maxZoom: 16, 
                    enableHighAccuracy: false // Modo WiFi/Antenas (M√°s compatible)
                });
            } else {
                // Si el error es Permiso Denegado o Bloqueo de Seguridad (File://)
                alert("‚ö†Ô∏è EL GPS NO FUNCIONA:\n\nEs probable que est√©s abriendo el archivo directamente desde el celular.\n\nSOLUCI√ìN: Sube este archivo a una web segura (https) o usa un servidor local.");
                document.getElementById("contador").innerText = "GPS Bloqueado";
            }
        });

        fetch(SHEET_API).then(r => r.json()).then(data => {
            if(!data || data.length === 0) return;
            datosGlobales = data;
            inicializarFiltros(data);
            actualizarMapa();
        }).catch(err => alert("Error datos: " + err));

        function inicializarFiltros(data) {
            var transportistas = [...new Set(data.map(d => d.Transp))].filter(Boolean).sort();
            llenarSelect("filtroTransp", transportistas, "TODAS");
            var choferes = [...new Set(data.map(d => d.Chofer))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS");
            generarPanelColores(choferes);
        }

        function llenarSelect(id, lista, titulo) {
            var s = document.getElementById(id);
            s.innerHTML = "";
            var o = document.createElement("option"); o.value = "todos"; o.innerText = titulo; s.appendChild(o);
            lista.forEach(i => { if(i && i.trim()){ var op = document.createElement("option"); op.value = i; op.innerText = i; s.appendChild(op); }});
        }

        function cambioTransportadora() {
            var t = document.getElementById("filtroTransp").value;
            var fil = (t === "todos") ? datosGlobales : datosGlobales.filter(d => d.Transp === t);
            var choferes = [...new Set(fil.map(d => d.Chofer))].filter(Boolean).sort();
            llenarSelect("filtroChofer", choferes, "TODOS");
            document.getElementById("filtroChofer").value = "todos";
            actualizarMapa();
        }

        function agruparPorCliente(datos) {
            const grupos = {};
            datos.forEach(i => {
                const k = i.Chofer + "_" + (i.CodBoca || i.Latitud + i.Longitud);
                if (!grupos[k]) grupos[k] = { ...i, _f: new Set(), _p: new Set(), _peso: 0, _imp: 0, _c: 0 };
                grupos[k]._f.add(i.NumFactura);
                grupos[k]._p.add(i.Pedido);
                
                let peso = parseFloat(String(i.Peso).replace(',', '.'));
                let imp = parseFloat(String(i.Importe).replace(/,/g, ''));
                if (!isNaN(peso)) grupos[k]._peso += peso;
                if (!isNaN(imp)) grupos[k]._imp += imp;
                grupos[k]._c++;
            });
            return Object.values(grupos);
        }

        function actualizarMapa() {
            layerGroup.clearLayers();
            if (userMarker) { userMarker.addTo(map); userCircle.addTo(map); } // Mantener GPS visible al filtrar

            var t = document.getElementById("filtroTransp").value;
            var c = document.getElementById("filtroChofer").value;
            var active = (t !== "todos" || c !== "todos");

            var fil = datosGlobales.filter(i => {
                if (t !== "todos" && i.Transp !== t) return false;
                if (c !== "todos" && i.Chofer !== c) return false;
                return true;
            });

            var ag = agruparPorCliente(fil);
            var count = 0; 

            ag.forEach(i => {
                var lat = parseFloat(String(i.Latitud).replace(',', '.'));
                var lon = parseFloat(String(i.Longitud).replace(',', '.'));

                if (!isNaN(lat) && !isNaN(lon)) {
                    count++;
                    var color = getColor(i.Chofer);
                    
                    var facts = Array.from(i._f).join(", ");
                    var peds = Array.from(i._p).join(", ");
                    var factsView = (i._f.size > 2) ? Array.from(i._f).slice(0, 3).join(", ") + "..." : facts;

                    var marker = L.circleMarker([lat, lon], {
                        radius: 8, fillColor: color, color: "#333", weight: 1, opacity: 1, fillOpacity: 0.9
                    });

                    if (active) {
                        marker.bindTooltip(i.Cliente, {
                            permanent: true, direction: 'right', className: 'label-boca', offset: [8, 0]
                        });
                    }

                    var html = `
                        <div class="popup-header">
                            <h3>${i.Cliente}</h3>
                            <small>${i.Ciudad} (Cod: ${i.CodBoca})</small>
                        </div>
                        <div class="badge-container">
                            <span class="badge" style="background:${color}">${i.Chofer}</span>
                            <span class="badge" style="background:#555">${i.Transp}</span>
                        </div>
                        <div class="popup-body">
                            <table class="info-table">
                                <tr><td class="label">Entregas</td><td class="value"><b>${i._c}</b></td></tr>
                                <tr><td class="label">Peso</td><td class="value">${i._peso.toFixed(2)} Kg</td></tr>
                                <tr><td class="label">Total</td><td class="value"><span class="highlight-money">Gs. ${formatoDinero.format(i._imp)}</span></td></tr>
                                <tr><td class="label">Facturas</td><td class="value" style="font-size:11px;">${factsView}</td></tr>
                                <tr><td class="label">Pedidos</td><td class="value" style="font-size:11px;">${peds}</td></tr>
                            </table>
                        </div>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="nav-btn">üìç IR AHORA</a>
                    `;
                    marker.bindPopup(html);
                    layerGroup.addLayer(marker);
                }
            });
            if (document.getElementById("contador").innerText !== "Ubicaci√≥n encontrada") {
                document.getElementById("contador").innerText = count + " entregas";
            }
        }

        function getColor(c) {
            if (coloresMemoria[c]) return coloresMemoria[c];
            var h = 0; for (var i=0; i<c.length; i++) h = c.charCodeAt(i) + ((h << 5) - h);
            return '#' + "00000".substring(0, 6 - (h & 0x00FFFFFF).toString(16).toUpperCase().length) + (h & 0x00FFFFFF).toString(16).toUpperCase();
        }

        function generarPanelColores(l) {
            var c = document.getElementById("lista-colores"); c.innerHTML = "";
            l.forEach(ch => {
                var r = document.createElement("div"); r.className = "chofer-row";
                r.innerHTML = `<span>${ch}</span> <input type="color" value="${getColor(ch)}" onchange="guardarColor('${ch}', this.value)">`;
                c.appendChild(r);
            });
        }

        function guardarColor(ch, co) {
            coloresMemoria[ch] = co; 
            try { localStorage.setItem('coloresLogisticaV9', JSON.stringify(coloresMemoria)); } catch(e){}
            actualizarMapa();
        }
        function togglePanel() { var p = document.getElementById("panel-colores"); p.style.display = (p.style.display==="none"||p.style.display==="")?"flex":"none"; }
    </script>
</body>
</html>